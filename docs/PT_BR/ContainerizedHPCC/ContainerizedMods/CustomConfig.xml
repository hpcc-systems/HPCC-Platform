<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<chapter id="CustomConfig">
  <title>Configurações Personalizadas</title>

  <sect1 id="CustTechniques" role="nobrk">
    <title>Técnicas de Customização</title>

    <para>Esta seção percorre a criação de um arquivo de configuração YAML
    personalizado e a implantação de uma plataforma HPCC Systems
    <superscript>®</superscript> usando a configuração padrão mais as
    personalizações. Uma vez que você entenda os conceitos neste capítulo,
    você pode se referir ao próximo capítulo para uma referência a todos os
    ajustes de valor de configuração.</para>

    <para>Há várias maneiras de personalizar uma implantação da plataforma.
    Nós recomendamos o uso de métodos que permitem que você aproveite melhor o
    configuração como práticas de código (CaC). A configuração como código é a
    padrão de gerenciamento de arquivos de configuração em um sistema de
    controle de versão ou repositório.</para>

    <para>A seguir uma lista de técnicas de customização:</para>

    <itemizedlist>
      <listitem>
        <para>A primeira maneira de substituir uma configuração padrão é
        através da linha de comando usando o parâmetro <emphasis
        role="bold">--set</emphasis>.</para>

        <para>Este é o mais fácil, mas o menos compatível com as diretrizes
        CaC. Também é mais difícil de rastrear as alterações.</para>
      </listitem>

      <listitem>
        <para>A segunda maneira é modificando os valores padrão e salvando por
        meio da seguinte linha de comando:</para>

        <programlisting>helm show values hpcc/hpcc &gt; myvalues.yamlj</programlisting>

        <para>Isso pode estar em conformidade com as diretrizes do CaC, se
        você colocar esse arquivo sob controle de versão, mas dificulta a
        utilização de uma nova configuração padrão quando uma estiver
        disponível.</para>
      </listitem>

      <listitem>
        <para>A terceira maneira, é a que normalmente usamos. Usar o padrão
        configuração, mais um arquivo YAML de personalização e o parâmetro -f
        (ou parâmetro --values) para o comando helm. Isso usa o padrão
        configuração e apenas substitui as configurações especificadas no
        personalização YAML. Além disso, você pode passar vários arquivos YAML
        no mesmo comando, se desejado.</para>

        <para>Para este tutorial, usaremos o terceiro método para levantar um
        plataforma com todas as configurações padrão, mas adicionar algumas
        personalizações. No primeiro exemplo, em vez de um Roxie, teremos
        dois. No segundo exemplo, ele adicionará um segundo 10-way
        Thor.</para>
      </listitem>
    </itemizedlist>

    <sect2 id="CustTutorial1" role="brk">
      <title>Criar um Custom Configuration Chart para Dois Roxies</title>

      <orderedlist>
        <listitem>
          <para>Se você ainda não adicionou o repositório HPCC Systems a sua
          lista de repositórios do helm, adicione-o agora.</para>

          <para><programlisting>helm repo add hpcc https://hpcc-systems.github.io/helm-chart/</programlisting></para>

          <para>Se você já adiciou, atualize para os últimos charts:</para>

          <para><programlisting>helm repo update</programlisting></para>
        </listitem>

        <listitem>
          <para>Crie um novo arquivo de texto, o nomeie para <emphasis
          role="bold">tworoxies.yaml</emphasis> e abra-o em um editor de
          texto.</para>

          <para>Você pode usar qualquer editor de texto.</para>
        </listitem>

        <listitem>
          <para>Salve os valores padrão em um arquivo de texto:</para>

          <para><programlisting>helm show values hpcc/hpcc &gt; myvalues.yaml</programlisting></para>
        </listitem>

        <listitem>
          <para>Abra o arquivo salvo (myvalues.yaml) em um editor de
          texto.</para>
        </listitem>

        <listitem>
          <para>Copie toda seção <emphasis role="bold">roxie:</emphasis> e
          cole dentro no novo arquivo tworoxies.yaml.</para>
        </listitem>

        <listitem>
          <para>Copie todo o conteúdo do novo arquivo tworoxies.yaml, exceto a
          primeira linha (roxie:), e cole no final do arquivo.</para>
        </listitem>

        <listitem>
          <para>No primeiro bloco, edite o valor para <emphasis
          role="bold">name:</emphasis> e altere o valor para <emphasis
          role="bold">roxie2.</emphasis></para>
        </listitem>

        <listitem>
          <para>No segundo bloco, edite o valor para <emphasis
          role="bold">prefix:</emphasis> e altere para <emphasis
          role="bold">roxie2.</emphasis></para>
        </listitem>

        <listitem>
          <para>No segundo bloco, edite o valor para <emphasis
          role="bold">name:</emphasis> abaixo de <emphasis
          role="bold">services:</emphasis> e altere para <emphasis
          role="bold">roxie2</emphasis>.</para>
        </listitem>

        <listitem>
          <para>Salve o arquivo e feche o editor de texto.</para>

          <para>O arquivo tworoxies.yaml file deve se parecer com este
          aqui:</para>

          <para><emphasis role="bold">Observação:</emphasis> Os comentários
          foram removidos para simplificar o examplo:</para>

          <para><programlisting>roxie:
- name: roxie
  disabled: false
  prefix: roxie
  services:
  - name: roxie
    servicePort: 9876
    listenQueue: 200
    numThreads: 30
    visibility: local
  replicas: 2  
  numChannels: 2
  serverReplicas: 0
  localAgent: false
  traceLevel: 1
  topoServer:
    replicas: 1

- name: roxie2
  disabled: false
  prefix: roxie2
  services:
  - name: roxie2
    servicePort: 9876
    listenQueue: 200
    numThreads: 30
    visibility: local
  replicas: 2  
  numChannels: 2
  serverReplicas: 0
  localAgent: false
  traceLevel: 1
  topoServer:
    replicas: 1
</programlisting></para>
        </listitem>
      </orderedlist>

      <para><emphasis role="bold">Deploy utilizando um novo chart de
      configuração personalizado.</emphasis></para>

      <orderedlist>
        <listitem>
          <para>Abra uma janela de terminal e navegue para o diretório onde
          você salvou o arquivo tworoxies.yaml.</para>
        </listitem>

        <listitem>
          <para>Faça o deploy do seu HPCC Systems Platform, adicionando a nova
          configuração ao comando:</para>

          <para><programlisting>helm install mycluster hpcc/hpcc -f tworoxies.yaml</programlisting></para>
        </listitem>

        <listitem>
          <para>Após você confirmar que seu deploy está sendo executado, abra
          o ECL Watch.</para>

          <para>Você deverá ver dois clusters Roxie disponíveis como Targets
          -- roxie e roxie2.</para>
        </listitem>
      </orderedlist>
    </sect2>

    <sect2 id="CustTutorial2" role="nobrk">
      <title>Crie um Novo Chart de Configuração para Dois Thors</title>

      <para>Você pode especificar mais de uma configuração de customização
      repetindo o parâmetro -f.</para>

      <para>Por exemplo:</para>

      <para><programlisting>helm install mycluster hpcc/hpcc  -f tworoxies.yaml -f twothors.yaml</programlisting></para>

      <para>Nesta seção, nós vamos adicionar um segundo Thor 10-way.</para>

      <orderedlist>
        <listitem>
          <para>Se você ainda não adicionou o repositório do HPCC Systems a
          lista de repositórios helm, adicione agora.<programlisting>helm repo add hpcc https://hpcc-systems.github.io/helm-chart/</programlisting></para>

          <para>Se você já adicionou, atualize os últimos charts:</para>

          <para><programlisting>helm repo update</programlisting></para>
        </listitem>

        <listitem>
          <para>Crie um novo arquivo de texto e nomeie-o <emphasis
          role="bold">twothors.yaml</emphasis> e abra-o em um editor de
          texto.</para>

          <para>Você pode usar qualquer editor de texto.</para>
        </listitem>

        <listitem>
          <para>Em um editor de texto, abra o arquivo de valores padrão que
          você salvou anteriormente (myvalues.yaml).</para>
        </listitem>

        <listitem>
          <para>Copie por inteiro a seção <emphasis
          role="bold">thor:</emphasis> e cole no novo arquivo
          twothors.yaml.</para>
        </listitem>

        <listitem>
          <para>Copie todo conteúdo para o novo arquivo twothors.yaml, exceto
          a primeira linha (thor:), e cole no final do arquivo.</para>
        </listitem>

        <listitem>
          <para>No segundo bloco, edite o valor para <emphasis
          role="bold">name:</emphasis> e altere-o para <emphasis
          role="bold">thor10.</emphasis></para>
        </listitem>

        <listitem>
          <para>No segundo bloco, edite o valor para <emphasis
          role="bold">prefix:</emphasis> e altere-o para <emphasis
          role="bold">thor10.</emphasis></para>
        </listitem>

        <listitem>
          <para>No segundo bloco, edite o valor para <emphasis
          role="bold">numWorkers:</emphasis> e altere-o para <emphasis
          role="bold">10.</emphasis></para>
        </listitem>

        <listitem>
          <para>Salve o arquivo e feche o editor de texto.</para>

          <para>O resultado do arquivo do twothors.yaml deve se parecer
          assim</para>

          <para><emphasis role="bold">Nota:</emphasis> Os comentários foram
          removidos para simplificar o exemplo:</para>

          <para><programlisting>thor:
- name: thor
  prefix: thor
  numWorkers: 2
  maxJobs: 4
  maxGraphs: 2
- name: thor10
  prefix: thor10
  numWorkers: 10
  maxJobs: 4
  maxGraphs: 2</programlisting></para>
        </listitem>
      </orderedlist>

      <para><emphasis role="bold">Deploy utilizando o novo chart de
      configuração personalizado.</emphasis></para>

      <orderedlist>
        <listitem>
          <para>Abra uma janela de terminal e navegue para o diretório onde
          você salvou o arquivo twothors.yaml.</para>
        </listitem>

        <listitem>
          <para>Faça o deploy do seu HPCC Systems Platform, adicionando a nova
          configuração ao comando:</para>

          <para><programlisting># If you have previously stopped your cluster

helm install mycluster hpcc/hpcc -f tworoxies.yaml -f twothors.yaml

# To upgrade without stopping

helm upgrade mycluster hpcc/hpcc -f tworoxies.yaml -f twothors.yaml
</programlisting></para>
        </listitem>

        <listitem>
          <para>Após você confirmar que seu deploy está sendo executado, abra
          o ECL Watch.</para>

          <para>Você deverá ver dois clusters Thor disponíveis como Targets --
          thor and thor10.</para>
        </listitem>
      </orderedlist>
    </sect2>

    <sect2 id="HelmAllowPipeProgramsThor" role="nobrk">
      <title>Crie um Chart de Configuração Personalizado para
      AllowPipePrograms</title>

      <para>Você pode especificar mais de uma configuração personalizada
      repetindo o parâmetro -f.</para>

      <para>Por exemplo:</para>

      <para><programlisting>helm install mycluster hpcc/hpcc  -f tworoxies.yaml -f thorWithPipe.yaml</programlisting></para>

      <para>Nesta seção, modificaremos o Thor para permitir alguns Programas
      PIPE. Na versão 9.2.0 e superior, os comandos usados ​​no PIPE são
      restritos por padrão em implantações containerizadas a menos que sejam
      explicitamente permitidos no Helm chart.</para>

      <orderedlist>
        <listitem>
          <para>Se você ainda não adicionou o repositório HPCC Systems a lista
          de repositórios Helm, faça agora.</para>

          <para><programlisting>helm repo add hpcc https://hpcc-systems.github.io/helm-chart/</programlisting></para>

          <para>Se você ja adicionou, atualiza os últimos:</para>

          <para><programlisting>helm repo update</programlisting></para>
        </listitem>

        <listitem>
          <para>Crie um novo arquivo de texto e o nomeie de <emphasis
          role="bold">thorWithPipe.yaml</emphasis> e abra-o em um editor de
          texto.</para>

          <para>Você pode usar qualque editor de texto.</para>
        </listitem>

        <listitem>
          <para>Abra o arquivo padrão de valores que você salvou previamente
          (myvalues.yaml) em um editor de texto.</para>
        </listitem>

        <listitem>
          <para>Copie a seção <emphasis role="bold">thor:</emphasis> toda e
          cole no novo arquivo thorWithPipe.yaml.</para>
        </listitem>

        <listitem>
          <para>Adicione um bloco no fim:</para>

          <para><programlisting>  allowedPipePrograms: 
  - sort 
  - grep 
  - echo</programlisting>Este exemplo habilita três programas. Você pode um
          deles.</para>
        </listitem>

        <listitem>
          <para>Salve o arquivo e feche o editor de texto.</para>

          <para>O resultado deve do arquivo thorWithPipe.yaml deve ficar
          assim</para>

          <para><emphasis role="bold">Nota:</emphasis> Os comentários foram
          removidos para simplificar o exemplo:</para>

          <para><programlisting>thor:
- name: thor
  prefix: thor
  numWorkers: 2
  maxJobs: 4
  maxGraphs: 2
  allowedPipePrograms:
  - sort
  - grep
  - echo</programlisting></para>
        </listitem>
      </orderedlist>

      <para><emphasis role="bold">Faça o deploy utilizando o novo chart de
      configuração customizado.</emphasis></para>

      <orderedlist>
        <listitem>
          <para>Abra uma janela de terminal e navegue até o diretório onde o
          arquivo thorWithPipe.yaml foi salvo.</para>
        </listitem>

        <listitem>
          <para>Faça o deploy da sua plataforma HPCC Systems, adicionando o
          novo arquivo de configuração por meio do comando:</para>

          <para><programlisting># If you have previously stopped your cluster

helm install mycluster hpcc/hpcc -f thorWithPipe.yaml

# To upgrade without stopping

helm upgrade mycluster hpcc/hpcc -f thorWithPipe.yaml
</programlisting></para>
        </listitem>

        <listitem>
          <para>Após confirmar o deploy em execução, execute um job que use
          uma ação PIPE e especifica um dos programas especificado.</para>

          <para><emphasis role="bold">Nota:</emphasis> Se o job for muito
          simples, será executado no hThor ao inves do Thor e este exemplo não
          habilita programas PIPE no hThor.</para>

          <para>Você pode criar um novo arquivo yaml para permitir Programas
          PIPE no ECL Agent ou pode utilizar:</para>

          <para><programlisting>#OPTION('pickBestEngine',FALSE);</programlisting></para>

          <para>para forçar o job ser executado no Thor.</para>
        </listitem>
      </orderedlist>
    </sect2>
  </sect1>

  <sect1>
    <sect2 id="CustTutorial3" role="nobrk">
      <title>Criar uma Configuração Personalizada do Chart para o Thor</title>

      <para>Nesta seção, criaremos um arquivo YAML para especificar uma
      implementação de plataforma sem Thor.</para>

      <orderedlist>
        <listitem>
          <para>Se você ainda não adicionou o repositório HPCC Systems
          repository to a lista de repositórios do helm, faça agora.</para>

          <para>
            <programlisting>helm repo add hpcc https://hpcc-systems.github.io/helm-chart/</programlisting>
          </para>

          <para>Caso já tenha feito, atualize os últimos charts:</para>

          <para>
            <programlisting>helm repo update</programlisting>
          </para>
        </listitem>

        <listitem>
          <para>Crie um novo arquivo de texto e o nomeie para <emphasis
          role="bold">nothor.yaml</emphasis> e abra-o em um editor de
          texto.</para>

          <para>Você pode usar qualquer editor.</para>
        </listitem>

        <listitem>
          <para>Edite, conforme o exemplo a seguir, o arquivo para desabilitar
          o Thor:</para>

          <para>
            <programlisting>thor: []</programlisting>
          </para>
        </listitem>

        <listitem>
          <para>Salve o arquivo e feche o editor de texto.</para>
        </listitem>
      </orderedlist>

      <para>
        <emphasis role="bold">Deploy utilizando um novo chart de configuração
        customizado.</emphasis>
      </para>

      <orderedlist>
        <listitem>
          <para>Abra o terminal e navegue até o diretório onde está salvo o
          arquivo nothor.yaml.</para>
        </listitem>

        <listitem>
          <para>Faça o deploy do HPCC Systems, incluindo no seu comando a nova
          configuração:</para>

          <para>
            <programlisting># If you have previously stopped your cluster

helm install mycluster hpcc/hpcc -f nothor.yaml

# To upgrade without stopping

helm upgrade mycluster hpcc/hpcc -f nothor.yaml</programlisting>
          </para>
        </listitem>

        <listitem>
          <para>Após confirmar que seu deploy está em execução, abra o ECL
          Watch.</para>

          <para>Você não irá ver nenhum cluster Thor como destino.</para>
        </listitem>
      </orderedlist>
    </sect2>

    <sect2 id="CustTutorial4" role="brk">
      <title>Crie um Chart de Configuração Personalizada para o Roxie</title>

      <para>Nesta seção, criaremos um arquivo YAML para especificar uma
      implementação de plataforma sem Roxie. Embora o resultado seja
      semelhante ao que fizemos na seção anterior para sem Thor, a técnica é
      diferente.</para>

      <orderedlist>
        <listitem>
          <para>Se você ainda não adicionou o respositório do HPCC Systems a
          lista de respositórios helm, faça agora.</para>

          <para>
            <programlisting>helm repo add hpcc https://hpcc-systems.github.io/helm-chart/</programlisting>
          </para>

          <para>Caso já tenha feito, atualize os últimos charts:</para>

          <para>
            <programlisting>helm repo update</programlisting>
          </para>
        </listitem>

        <listitem>
          <para>Crie um novo arquivo de texto e o nomeie para <emphasis
          role="bold">noroxie.yaml</emphasis> e abra-o em um editor de
          texto.</para>

          <para>Você pode usar qualquer editor de texto.</para>
        </listitem>

        <listitem>
          <para>Salve os valores padrão em um arquivo de texto:</para>

          <para>
            <programlisting>helm show values hpcc/hpcc &gt; myvalues.yaml</programlisting>
          </para>
        </listitem>

        <listitem>
          <para>Abra o arquivo salvo (myvalues.yaml) em um editor de
          texto.</para>
        </listitem>

        <listitem>
          <para>Copie a seção <emphasis role="bold">roxie:</emphasis> e cole
          no novo arquivo noroxie.yaml.</para>
        </listitem>

        <listitem>
          <para>Copie a seção <emphasis role="bold">eclagent:</emphasis> e
          cole no novo arquivo noroxie.yaml.</para>
        </listitem>

        <listitem>
          <para>No bloco <emphasis role="bold">roxie</emphasis>, edite o valor
          para <emphasis role="bold">disabled</emphasis>: e mude para
          <emphasis role="bold">true.</emphasis></para>

          <para>Você pode remover todo o resto do bloco roxie: exceto o
          nome.</para>
        </listitem>

        <listitem>
          <para>No bloco <emphasis role="bold">eclagent</emphasis>, delete
          todo o bloco <emphasis role="bold">name:
          roxie-workunit</emphasis>.</para>

          <para>Isso remove a instância de um Roxie atuando como um Agente
          ECL.</para>
        </listitem>

        <listitem>
          <para>Salve e feche o editor de texto.</para>

          <para>O arquivo noroxie.yaml deverá parecer como este:</para>

          <para><emphasis role="bold">Nota:</emphasis> Os comentários foram
          removidos para simplificar o exemplo:</para>

          <para>
            <programlisting>roxie:
- name: roxie
  disabled: true
  
eclagent:
- name: hthor
  replicas: 1
  maxActive: 4
  prefix: hthor
  useChildProcesses: false
  type: hthor</programlisting>
          </para>
        </listitem>
      </orderedlist>

      <para>
        <emphasis role="bold">Faça o deploy usando o novo chart de
        configuração personalizada.</emphasis>
      </para>

      <orderedlist>
        <listitem>
          <para>Abra uma janela de terminal e navegue até o diretório onde
          está salvo o arquivo noroxie.yaml.</para>
        </listitem>

        <listitem>
          <para>Faça o deploy do HPCC Systems, incluindo no seu comando a nova
          configuração:</para>

          <para>
            <programlisting>helm install mycluster hpcc/hpcc -f noroxie.yaml</programlisting>
          </para>
        </listitem>

        <listitem>
          <para>Após confirmar que seu deploy está em execução, abra o ECL
          Watch.</para>

          <para>Você não irá mais ver nenhum cluster Roxie disponível como
          destino.</para>
        </listitem>
      </orderedlist>
    </sect2>

    <sect2 id="threeiThorsOneQueue" role="nobrk">
      <title>Crie um Chart de Configuração Personalizado para Múltiplos Thors
      Ouvindo uma Fila Comum.</title>

      <para>Nesta seção, criaremos três Thors que escutam uma fila comum (além
      de sua própria fila). Isso fornece a capacidade de definir configurações
      distintas de cluster Thor, mas permite que eles formem um único alvo
      atrás de uma única fila. Esses clusters podem ser vinculados a
      determinados conjuntos de nós em diferentes zonas de disponibilidade, se
      desejado. Você pode usar este exemplo como um ponto de partida e ajustar
      o número de clusters Thor que deseja.</para>

      <para>Isso é alcançado definindo filas de destino auxiliares adicionais
      para cada definição de Thor e usando um nome comum como uma fila
      auxiliar.</para>

      <orderedlist>
        <listitem>
          <para>Se você ainda não adicionou o respositório do HPCC Systems a
          lista de respositórios helm, faça agora.</para>

          <para>
            <programlisting>helm repo add hpcc https://hpcc-systems.github.io/helm-chart/</programlisting>
          </para>

          <para>Se já fez isso, atualize os últimos charts:</para>

          <para>
            <programlisting>helm repo update</programlisting>
          </para>
        </listitem>

        <listitem>
          <para>Crie um novo arquivo de texto e o nomeie para <emphasis
          role="bold">threethorsonequeue.yaml </emphasis>e abra-o em um editor
          de texto.</para>

          <para>Você pode usar qualquer editor de texto.</para>
        </listitem>

        <listitem>
          <para>Abra o arquivo padrão de valores que você salvou previamente
          (myvalues.yaml) em um editor de texto.</para>
        </listitem>

        <listitem>
          <para>Copie <emphasis role="bold">thor:</emphasis> e cole no novo
          arquivo threethorsonequeue.yaml file.</para>
        </listitem>

        <listitem>
          <para>Copie todo o conteúdo do novo arquivo yaml file, exceto a
          primeira linha (thor:), e cole no final do arquivo <emphasis
          role="bold">twice</emphasis>.</para>

          <para>Isso cria três seções - name:.</para>
        </listitem>

        <listitem>
          <para>Edite o arquivo da seguinte maneira:</para>

          <para>
            <orderedlist>
              <listitem>
                <para>De um único valor de <emphasis
                role="bold">name</emphasis> para cada Thor<emphasis
                role="bold">:</emphasis>.</para>

                <para>Neste exemplo, utilizaremos <emphasis role="bold">thor1,
                thor2, </emphasis>e <emphasis
                role="bold">thor3</emphasis>.</para>
              </listitem>

              <listitem>
                <para>Adicione a entrada <emphasis
                role="bold">auxQueues:</emphasis> para cada block Thor block
                utilizando um nome comum</para>

                <para>Neste exemplo estamos utilizando:</para>

                <para>
                  <emphasis role="bold">auxQueues: [ thorQ ]</emphasis>
                </para>
              </listitem>

              <listitem>
                <para>Certifique-se que o <emphasis
                role="bold">prefix:</emphasis> é o mesmo que cada bloco do
                Thor.</para>
              </listitem>
            </orderedlist>
          </para>
        </listitem>

        <listitem>
          <para>Salve e feche o editor de texto.</para>

          <para>O arquivo threethorsonequeue.yaml deverá ficar assim:</para>

          <para><emphasis role="bold">Note:</emphasis> Os comentários foram
          removidos para simplificar o exemplo:</para>

          <para>
            <programlisting>thor:
- name: thor1
  auxQueues: [ thorQ ]
  maxGraphs: 2
  maxJobs: 2
  numWorkers: 4
  numWorkersPerPod: 2
  prefix: thor
- name: thor2
  maxGraphs: 2
  maxJobs: 2
  numWorkers: 4
  numWorkersPerPod: 2
  prefix: thor
  auxQueues: [ thorQ ]
- name: thor3
  maxGraphs: 2
  maxJobs: 2
  numWorkers: 4
  numWorkersPerPod: 2
  prefix: thor
  auxQueues: [ thorQ ]</programlisting>
          </para>
        </listitem>
      </orderedlist>

      <para>
        <emphasis role="bold">Faça o deploy usando o novo chart de
        configuração personalizada.</emphasis>
      </para>

      <orderedlist>
        <listitem>
          <para>Abra uma janela de terminal e navegue até o diretório onde
          está salvo o arquivo threethorsonequeue.yaml.</para>
        </listitem>

        <listitem>
          <para>Faça o deploy do HPCC Systems, incluindo no seu comando a nova
          configuração:</para>

          <para>
            <programlisting># If you have previously stopped your cluster

helm install mycluster hpcc/hpcc -f threethorsonequeue.yaml

# To upgrade without stopping

helm upgrade mycluster hpcc/hpcc -f threethorsonequeue.yaml
</programlisting>
          </para>
        </listitem>

        <listitem>
          <para>Após confirmar que seu deploy está em execução, abra o ECL
          Watch.</para>

          <para>Você deve ver quatro clusters Thor disponíveis como Alvos -
          thor1, thor2, thor3 e uma quarta fila que todos os três Thors ouvem
          - thorQ.</para>
        </listitem>
      </orderedlist>
    </sect2>

    <sect2 id="configwithlzonly" role="nobrk">
      <title>Crie um Chart de Configuração Personalizado somente para Landing
      Zone</title>

      <para>Nessa seção, nós iremos criar uma configuração personalizada que
      implementa uma "plataforma" contendo apenas uma Landing Zone. Isso pode
      ser útil se tudo o que você precisa é um servidor de landing zone com o
      dafilesrv rodando.</para>

      <para><emphasis role="bold">Nota:</emphasis> Isso só pode ser
      implementado em um namespace diferente de qualquer outra instância de
      plataforma.</para>

      <orderedlist>
        <listitem>
          <para>Se você ainda não adicionou o respositório do HPCC Systems a
          lista de respositórios helm, faça agora.</para>

          <para>
            <programlisting>helm repo add hpcc https://hpcc-systems.github.io/helm-chart/</programlisting>
          </para>

          <para>Se já fez isso, atualize os últimos charts:</para>

          <para>
            <programlisting>helm repo update</programlisting>
          </para>
        </listitem>

        <listitem>
          <para>Criar um novo arquivo de texto e o nomeie para <emphasis
          role="bold">lz.yaml</emphasis> e abra-o em um editor de
          texto.</para>

          <para>Você pode usar qualquer editor de texto.</para>
        </listitem>

        <listitem>
          <para>Copie e cole este código no arquivo:</para>

          <para>
            <programlisting>dafilesrv:
- name: direct-access
  application: directio
  service:
    servicePort: 7100
    visibility: local
    tls: false
  resources:
    cpu: "2"
    memory: "8G"
dali: []
dfuserver: []
eclagent: []
eclccserver: []
eclscheduler: []
esp: []
roxie: []
sasha: null
thor: []
</programlisting>
          </para>
        </listitem>

        <listitem>
          <para>Salve e feche o editor de texto.</para>
        </listitem>
      </orderedlist>

      <para>
        <emphasis role="bold">Faça o deploy usando o novo chart de
        configuração personalizada.</emphasis>
      </para>

      <orderedlist>
        <listitem>
          <para>Abra uma janela de terminal e navegue até o diretório onde
          está salvo o arquivo lz.yaml file.</para>
        </listitem>

        <listitem>
          <para>Implante esta "plataforma" LZ somente com a nova configuração
          adicionada ao seu comando.</para>

          <para>
            <programlisting>helm install mylz hpcc/hpcc -f lz.yaml
</programlisting>
          </para>
        </listitem>

        <listitem>
          <para>Confirme que está instalado usando este comando:</para>

          <para>
            <programlisting>helm list </programlisting>
          </para>
        </listitem>
      </orderedlist>
    </sect2>
  </sect1>

  <sect1 id="CostTracking1">
    <title>Rastreamento de Custos de Contêineres</title>

    <para>Com o advento da plataforma de sistemas HPCC em contêineres,
    introduzimos informações de rastreamento de custos. Isso é particularmente
    útil ao usar instâncias de plataforma HPCC Systems nativas da nuvem em uma
    configuração de nuvem em que algum planejamento e configuração podem
    ajudar a reduzir as despesas.</para>

    <para>Duas novas colunas foram adicionadas à página de workunits no ECL
    Watch. As colunas podem ser classificadas por qualquer coluna de custo,
    assim como as outras colunas no ECL Watch, clicando no topo da
    coluna.</para>

    <sect2 id="TypesOfCosts">
      <title>Tipos de custos</title>

      <para>Existem três tipos de custos que são rastreados.</para>

      <para><itemizedlist>
          <listitem>
            <para>Custos de Execução</para>
          </listitem>

          <listitem>
            <para>Custos de Armazenamento</para>
          </listitem>

          <listitem>
            <para>Custo de Acesso a Arquivo</para>
          </listitem>
        </itemizedlist></para>

      <variablelist>
        <varlistentry>
          <term>OBSERVAÇÃO:</term>

          <listitem>
            <para>Todos os valores de custo calculados e exibidos são
            aproximados. Existem muitas variáveis que podem resultar em
            imprecisões. Esses valores de custo devem ser usados apenas como
            um guia.</para>
          </listitem>
        </varlistentry>
      </variablelist>

      <sect3 id="ExecutionCost">
        <title>Custos de Execução</title>

        <para>Custo de execução é o valor referente a custo de execução da
        workunit, do graph e subgraphs no cluster Thor. Inclui o custo de
        todos os nós diretamente necessários para executar o trabalho e inclui
        o custo de:</para>

        <para><itemizedlist>
            <listitem>
              <para>Nós do executor</para>
            </listitem>

            <listitem>
              <para>Nós do Compilador</para>
            </listitem>

            <listitem>
              <para>Nós do agente e do gereciador</para>
            </listitem>
          </itemizedlist></para>

        <para>O valor do custo de execução de uma workunit é exibido no ECL
        Watch em sua página de resumo e é organizado em grap, subgraph e nível
        de atividade. Os valores de custo do graphh e do subgraph estão
        disponíveis no visualizador de métricas e graph.</para>

        <para><variablelist>
            <varlistentry>
              <term>Observação:</term>

              <listitem>
                <para>O custo de execução das workunits ROXIE não está
                implementado atualmente.</para>
              </listitem>
            </varlistentry>
          </variablelist></para>

        <sect4 id="JobGuillotine">
          <title>Job Guilhotina</title>

          <para>O de risco de custos descontrolados é uma preocupação para
          cobrança baseada em uso potencialmente ilimitada. Assim, o recurso
          job guilhotina é fornecido para gerenciar esse cenário, limitando os
          custos por meio dos valores limite e do limite rígido. Quando o
          custo de um job atinge um valor definido, ele pode ser encerrado,
          controlando os custos que podem incorrer.</para>

          <variablelist>
            <varlistentry>
              <term>Observação:</term>

              <listitem>
                <para>Esta funcionalidade atualmente é suportada somente para
                os jobs do Thor.</para>
              </listitem>
            </varlistentry>
          </variablelist>

          <graphic fileref="../../images/SCOST_img3_1.jpg"><!--ADD-IMAGE--></graphic>
        </sect4>
      </sect3>

      <sect3 id="StorageCOsts">
        <title>Custo de armazenamento</title>

        <para>Esse é o custo de hospedar os dados no plano de armazenamento.
        Não inclui os custos das operações de dados, como custos de leitura ou
        gravação.</para>

        <para><variablelist>
            <varlistentry>
              <term>Observação:</term>

              <listitem>
                <para>Os custos não são registrados para arquivos temporários
                ou de derramamento, porque o armazenamento local está incluído
                no preço da VM usada para calcular os custos de
                execução.</para>
              </listitem>
            </varlistentry>
          </variablelist></para>

        <para>Os custos de armazenamento não podem ser vistos como um valor
        separado no ECL Watch. Eles só podem ser visualizados como parte de um
        campo de custo na página de resumo de um arquivo lógico.</para>
      </sect3>

      <sect3 id="FileAccessCosts">
        <title>Custo de acesso aos arquivos</title>

        <para>Os custos de leitura e gravação em arquivos são referidos como
        custos de acesso a arquivos. Vários planos de armazenamento cobram por
        operações de dados separadamente. O valor do custo de acesso ao
        arquivo incluirá o custo de leitura e gravação. Neste momento,
        quaisquer outros custos relacionados com ações de arquivo (como
        excluir ou copiar) não serão registrados ou incluídos como parte dos
        custos.</para>

        <para>Na página de resumo Logical File no ECL Watch, o custo de acesso
        ao arquivo aparece como parte do campo de custo.</para>

        <para>As despesas de uma workunit para acessar arquivos lógicos também
        são incluídas nas estatísticas e atributos da workunit. O custo de
        leitura/gravação é relatado no registro da atividade e somado nos
        níveis de graph, subgraph e escopo do fluxo de trabalho.</para>

        <para>O custo geral de acesso a arquivos para uma workunit é rastreado
        e relatado na página de resumo.</para>

        <para>Na página de resumo Logical File, você pode ver o novo campo de
        custo. É o custo total de armazenamento e acesso aos dados.
        Atualmente, as informações de custo são geradas apenas para jobs Thor
        e hThor.</para>
      </sect3>
    </sect2>

    <sect2 id="CostsConfigurations">
      <title>Custo de Configuração</title>

      <para>Esta seção detalha a configuração dos parâmetros de configuração
      dos jobst. A configuração dos custos do jobs trabalho em uma instância
      HPCC Systems sistemas HPCC nativos da nuvem é feita usando o chart helm.
      Por padrão, o arquivo <emphasis>values.yaml</emphasis> fornecido contém
      uma seção para configurar custos.</para>

      <para>Por exemplo:</para>

      <orderedlist>
        <listitem>
          <para>Crie um novo arquivo de texto e o nomeie <emphasis
          role="bold">mycosts.yaml</emphasis> e abra em um editor de
          texto.</para>

          <para>Você pode usar um editor de texto.</para>
        </listitem>

        <listitem>
          <para>Salve os valores padrão em um arquivo de texto:</para>

          <para><programlisting>helm show values hpcc/hpcc &gt; myvalues.yaml</programlisting></para>
        </listitem>

        <listitem>
          <para>Abra o arquivo salvo (myvalues.yaml) em um editor de
          texto.</para>
        </listitem>

        <listitem>
          <para>Copie a sessão <emphasis role="bold">cost:</emphasis> e cole
          em outro novo arquivo mycosts.yaml.</para>
        </listitem>

        <listitem>
          <para>Altere quaisquer valores relacionados a custos desejados,
          conforme apropriado.</para>
        </listitem>

        <listitem>
          <para>Salve o arquivo e feche o editor de texto.</para>
        </listitem>

        <listitem>
          <para>Implante sua plataforma HPCC Systems, adicionando a nova
          configuração ao seu comando:</para>

          <para><programlisting>helm install mycluster hpcc/hpcc -f mycosts.yaml</programlisting></para>
        </listitem>
      </orderedlist>

      <para>Os valores de configuração fornecem as informações de preços e
      informações de formatação de moeda. Os seguintes parâmetros de
      configuração de custo são suportados:The configuration values provide
      the pricing information and currency formatting information. The
      following cost configuration parameters are supported:</para>

      <para><informaltable colsep="1" frame="all" rowsep="1">
          <tgroup cols="2">
            <colspec align="left" colwidth="122.40pt"/>

            <colspec/>

            <tbody>
              <row>
                <entry><emphasis>currencyCode</emphasis></entry>

                <entry>Usado para formatação de moeda de valores de
                custo.</entry>
              </row>

              <row>
                <entry><emphasis>perCpu</emphasis></entry>

                <entry>Custo por hora de uma única CPU.</entry>
              </row>

              <row>
                <entry><emphasis>storageAtRest</emphasis></entry>

                <entry>Custo de armazenamento por gigabyte por mês.</entry>
              </row>

              <row>
                <entry><emphasis>storageReads</emphasis></entry>

                <entry>Custo por 10.000 operações de leitura.</entry>
              </row>

              <row>
                <entry><emphasis>storageWrites</emphasis></entry>

                <entry>Custo por 10.000 operações de gravação.</entry>
              </row>
            </tbody>
          </tgroup>
        </informaltable></para>

      <sect3 id="ConfiguringCloudCosts">
        <title>Configurando custos da Nuvem</title>

        <para>O arquivo de configuração <emphasis>values.yaml</emphasis>
        padrão é configurado com os seguintes parâmetros de custo na seção
        global/cost:</para>

        <programlisting>  cost:
    currencyCode: USD
    perCpu: 0.126
    storageAtRest: 0.0135
    storageReads: 0.0485
    storageWrites: 0.0038
</programlisting>

        <para>O atributo <emphasis role="bold">currencyCode</emphasis> deve
        ser configurado com o código de país ISO 4217. (O padrão da plataforma
        HPCC Systems é USD se o código da moeda estiver faltando).</para>

        <para>O <emphasis role="bold">perCpu</emphasis> da seção global/cost
        se aplica a todos os componentes que não foram configurados com seu
        próprio valor perCpu.</para>

        <para>Um valor perCpu específico para um componente pode ser definido
        adicionando um atributo cost/perCPU na seção desse componente.</para>

        <para>Para componentes Dali:</para>

        <programlisting>  dali:
    - name: mydali
      <emphasis role="bold">cost:
        perCpu: </emphasis>0.24</programlisting>
      </sect3>

      <sect3 id="ThorCostsConfiguration">
        <title>Configuração dos Custos do Thor</title>

        <para>Os componentes Thor suportam parâmetros de custo adicionais que
        são usados para o recurso de "guilhotina" de trabalho:</para>

        <para><informaltable colsep="1" frame="all" rowsep="1">
            <tgroup cols="2">
              <colspec align="left" colwidth="122.40pt"/>

              <colspec/>

              <tbody>
                <row>
                  <entry><emphasis>limit </emphasis></entry>

                  <entry>Define o limite de custo “flexível” que uma unidade
                  de trabalho pode incorrer. O limite é “suave” no sentido de
                  que pode ser substituído pela opção do ECL <emphasis
                  role="bold">maxCost</emphasis>. Um nó será encerrado se
                  exceder seu <emphasis role="bold">maxCost</emphasis> (se
                  definido) ou o valor do atributo limite (se o <emphasis
                  role="bold">maxCost</emphasis> não for definido).</entry>
                </row>

                <row>
                  <entry><emphasis>hardlimit</emphasis></entry>

                  <entry>Define o limite de custo máximo absoluto, um limite
                  que não pode ser substituído pela configuração da opção ECL.
                  O valor <emphasis role="bold">maxCost</emphasis> que exceder
                  o hardlimit será ignorado.</entry>
                </row>
              </tbody>
            </tgroup>
          </informaltable></para>

        <para>O exemplo a seguir define os limites de custo dos trabalhos,
        adicionando os atributos à seção Thor do yaml de configuração.</para>

        <programlisting>thor:
- name: thor
  prefix: thor
  numWorkers: 2
  maxJobs: 4
  maxGraphs: 2
  <emphasis role="bold">cost:
    limit: 10.00   </emphasis>   # maximum cost is $10, overridable with maxCost option
    <emphasis role="bold">hardlimit: 20.00</emphasis>  # maximum cost is $20, cannot be overridden</programlisting>
      </sect3>

      <sect3 id="StorageCostParameters">
        <title>Parâmetros dos Custos de Armazenamentos</title>

        <para>Os parâmetros de custos de armazenamentos (<emphasis
        role="bold">storageAtRest</emphasis>, <emphasis
        role="bold">storageReads</emphasis> e <emphasis
        role="bold">storageWrites</emphasis>) podem ser adicionados na seção
        de custo do plano de armazenamento para definir parâmetros de custo
        específicos para o plano de armazenamento.</para>

        <para>Por exemplo:</para>

        <programlisting>storage:
  planes:
  - name: dali
    storageClass: ""
    storageSize: 1Gi
    prefix: "/var/lib/HPCCSystems/dalistorage"
    pvc: mycluster-hpcc-dalistorage-pvc
    category: dali
    <emphasis role="bold">cost:
      storageAtRest:</emphasis> 0.01
      <emphasis role="bold">storageReads:</emphasis> 0.001
      <emphasis role="bold">storageWrites:</emphasis> 0.04
</programlisting>

        <para>Os parâmetros de custo de armazenamento na seção global são
        usados apenas se nenhum parâmetro de custo for especificado no plano
        de armazenamento.</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 id="SecureLDAPaminCreds_forConatiners">
    <title>Protegendo Credenciais</title>

    <para>Utilizar o HPCC Systems em um ambiente containerizado tem algumas
    preocupações de segurança únicas, ao externalizar componentes normalmente
    internalizados, como as credenciais dos administradores LDAP.</para>

    <para>A proteção das credenciais dos administradores LDAP é realizada
    usando os segredos do Kubernetes ou do Hashicorp Vault. Como
    pré-requisito, você deve estar familiarizado com a configuração de
    segredos do Kubernetes e/ou do Hashicorp Vault.</para>

    <para>A conta dos administradores LDAP deve ter direitos de administrador
    para todos os Base DNs usados pela plataforma HPCC Systems. Em uma
    implantação na nuvem, essas credenciais podem ser expostas. Portanto, uma
    boa prática para essas credenciais de administrador é serem protegidas
    usando segredos do Kubernetes ou o HashiCorp Vault.</para>

    <sect2 id="SecuringCredentials_For_KubernetesSecrets">
      <title>Protegedo as credenciais no Kubernetes</title>

      <para>Para criar um secret no Kubernetes para armazenar as credenciais
      da conta do usuário do administrador do LDAP, use uma interface de linha
      de comando para o Kubernetes e execute um comando semelhante ao seguinte
      exemplo:</para>

      <programlisting lang="bash">kubectl create secret generic admincredssecretname --from-literal=username=hpcc_admin \
  --from-literal=password=t0pS3cr3tP@ssw0rd
</programlisting>

      <para>No exemplo acima, o nome do secret do Kubernetes é
      "admincredssecretname", e ele contém as chaves/valores "username" e
      "password" da conta do administrador do LDAP. Isso armazena o nome de
      usuário e a senha do administrador do LDAP como um segredo do
      Kubernetes. Quaisquer propriedades adicionais são ignoradas.</para>

      <para>Você pode verificar o secret que acabou de criar executando o
      seguinte comando no Kubernetes.</para>

      <programlisting lang="bash">kubectl get secret admincredssecretname</programlisting>

      <para>Para obter mais informações sobre o Kubernetes, consulte a
      documentação específica para a sua implementação..</para>

      <sect3 id="Using_TheKubernetesSecret">
        <title>Utilizando secrets do Kubernetes</title>

        <para>Para implementar os secrets do Kubernetes, substitua a seção
        "secrets:" em HPCC-Platform/helm/hpcc/values.yaml, ou implemente com o
        seu próprio gráfico personalizado. Para mais informações sobre como
        personalizar sua implementação contêinerizada de Sistemas HPCC, veja
        as seções acima sobre técnicas de personalização.</para>

        <para>No seu chat, crie um nome de chave único usado para referenciar
        o segredo, e defina-o como o nome do secret que você criou na etapa
        anterior. No exemplo acima, era "admincredssecretname".</para>

        <para>Você pode, opcionalmente, definir segredos adicionais conforme
        necessário pela configuração de segurança da sua plataforma. Cada um
        desses segredos seria criado conforme descrito acima e receberia nomes
        únicos. O exemplo abaixo indica como você pode adicionar quaisquer
        credenciais ou secrets adicionais aos seus chart Helm, se
        necessário.</para>

        <para>A chave/valor "admincredsmountname" já existe por padrão no
        arquivo values.yaml fornecido pelo HPCC Systems. A chave é
        referenciada no arquivo ldap.yaml do componente. Você pode substituir
        estes e adicionar chaves/valores adicionais conforme necessário. O
        seguinte exemplo ilustra a adição de "additionalsecretname" e esse
        nome deve corresponder ao nome do segredo adicional criado usando as
        etapas acima.</para>

        <programlisting lang="bash">  secrets:
     authn:
       admincredsmountname: "admincredssecretname"   #exernalize HPCC Admin creds
       additionalmountname: "additionalsecretname"   #alternate HPCC Admin creds
</programlisting>
      </sect3>

      <sect3 id="ENABLE_k8S_LDAP">
        <title>Habilitar autenticação LDAP</title>

        <para>No arquivo ldap.yaml fornecido em
        HPCC-Platform/esp/applications/common/ldap/, a "ldapAdminSecretKey" já
        está configurada para o nome da chave de montagem ilustrado no exemplo
        acima. Para habilitar a autenticação LDAP e modificar este valor, você
        ou seu administrador de sistemas podem substituir o componente Helm
        ESP/ECLWatch localizado no chart values.yaml, conforme ilustrado no
        exemplo seguinte:</para>

        <programlisting lang="YAML">esp:
- name: eclwatch
  application: eclwatch
  auth: ldap
  ldap:
    ldapAddress: "myldapserver"
    ldapAdminSecretKey: "additionaltmountname"  # use alternate secrets creds
</programlisting>

        <para/>
      </sect3>
    </sect2>

    <sect2 id="SecuringCreds_For_HashoCorpVault">
      <title>Protegendo crendeciais no HashiCorp Vault</title>

      <para>Para criar e armazenar secrets no HashiCorp Vault, a partir da
      linha de comando, execute os seguintes comandos Vault. O nome secreto
      usado no exemplo abaixo é "myvaultadmincreds" e deve ser prefixado com
      "secret/authn/" conforme ilustrado. As chaves/valores "username" e
      "password" do administrador LDAP são necessários. Propriedades
      adicionais são ignoradas.</para>

      <programlisting>vault kv put secret/authn/myvaultadmincreds username=hpcc_admin password=t0pS3cr3tP@ssw0rd </programlisting>

      <para>Onde "secret/authn/myvaultadmincreds" é o nome do secret que
      contém o nome de usuário e a senha do administrador LDAP.</para>

      <para>Para verificar e confirmar o valores do secret, execute o seguinte
      comando:</para>

      <programlisting lang="bash">vault kv get secret/authn/myvaultadmincreds</programlisting>

      <para>Para obter mais informações sobre como criar segredos para o
      HashiCorp Vault, consulte a documentação apropriada da HashiCorp para
      sua implementação.</para>

      <sect3 id="Deploying_HashiCorpVault">
        <title id="DeployingTheHashiCorpVault">Deploy do HashiCorp
        Vault</title>

        <para>Deploy dos secrets do HashiCorp Vault quando você sobrescrever a
        seção "secrets:" em HPCC-Platform/helm/hpcc/values.yaml, ou em seu
        chart de configuração personalizado. Para mais informações sobre como
        personalizar sua implantação containerizada do HPCC Systems, veja as
        seções acima sobre técnicas de personalização.</para>

        <para>O valor do nome do Vault é definido para este exemplo no chart
        gráfico de configuração values-secrets.yaml. Você pode encontrar um
        exemplo deste gráfico no repositório HPCC-Platform em
        /helm/examples/secrets/values-secrets.yaml.</para>

        <programlisting lang="YAML">  vaults:
  authn:
    - name: my-authn-vault
      #The data node in the URL is there for use by the REST API 
      #The path inside the vault starts after /data
      url: http://${env.VAULT_SERVICE_HOST}:${env.VAULT_SERVICE_PORT}/v1/secret/data/authn/${secret}
      kind: kv-v2
</programlisting>

        <para>Você pode inserir isso em seu próprio gráfico de personalização
        onde você fornece à sua implantação o nome do cofre que contém as
        credenciais.</para>
      </sect3>

      <sect3 id="REF_HASHICORPVault_LDAP">
        <title>Referenciando Vault Stored Authentication</title>

        <para>Os nomes de chave "ldapAdminSecretKey" e "ldapAdminVaultId" são
        usados pelo gerente de segurança do HPCC Systems para resolver os
        segredos, e devem corresponder exatamente quando se utiliza o nome do
        Vault configurado nas etapas anteriores.</para>

        <programlisting lang="YAML">esp:
- name: eclwatch
  application: eclwatch
  auth: ldap
  ldap:
    ldapAddress: "myldapserver"
    ldapAdminSecretKey: "myvaultadmincreds"
    ldapAdminVaultId: "my-authn-vault"
</programlisting>

        <para/>
      </sect3>
    </sect2>
  </sect1>
</chapter>

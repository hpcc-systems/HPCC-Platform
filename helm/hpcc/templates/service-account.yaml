{{/*

---  DO NOT EDIT THIS FILE - all configuration of HPCC platform should be done via values.yaml ----
  
##############################################################################

    HPCC SYSTEMS software Copyright (C) 2021 HPCC SystemsÂ®.

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
    
##############################################################################

*/}}
# The hpcc-default service account is used by ay component that doesn't need API access to launch child jobs
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hpcc-default
---
# The hpcc-agent service account is used by any component that DOES need API access to launch child jobs
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hpcc-agent
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: hpcc-agent
rules:
  - apiGroups: [ "" ] # core API group
    resources: [ "pods", "services" ]
    verbs: [ "get", "list" ]
  - apiGroups: [ "batch" ]
    resources: [ "jobs", "services" ]
    verbs: [ "get", "create", "list", "delete", "watch" ]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: hpcc-agent
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: hpcc-agent
subjects:
  - kind: ServiceAccount
    name: hpcc-agent
    namespace: {{ .Release.Namespace }}
---
# The hpcc-thoragent service account is used by thor agent, which needs not only to launch child jobs but also to set new NetworkPolicies
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hpcc-thoragent
---
# hpcc-thoragent needs to be able to manipulate jobs AND give the resulting pods the ability to see each other
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: hpcc-thoragent
rules:
  - apiGroups: [ "" ] # core API group
    resources: [ "pods", "services" ]
    verbs: [ "get", "list", "create" ]
  - apiGroups: [ "networking.k8s.io" ]
    resources: [ "networkpolicies" ]
    verbs: [ "get", "create", "delete" ]
  - apiGroups: [ "batch" ]
    resources: [ "jobs", "services" ]
    verbs: [ "get", "create", "list", "delete", "watch" ]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: hpcc-thoragent
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: hpcc-thoragent
subjects:
  - kind: ServiceAccount
    name: hpcc-thoragent
    namespace: {{ .Release.Namespace }}
---
# The hpcc-esp-service service account is used by esp components that need to be able to  check service status
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hpcc-esp-service
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: hpcc-esp-service
rules:
  - apiGroups: [ "" ] # core API group
    resources: [ "endpoints", "services", "pods" ]
    verbs: [ "get", "list" ]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: hpcc-esp-service
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: hpcc-esp-service
subjects:
  - kind: ServiceAccount
    name: hpcc-esp-service
    namespace: {{ .Release.Namespace }}
---
# The hpcc-dali service account is used by dali components that need to be able to find the external directio dafilesrv service
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hpcc-dali
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: hpcc-dali
rules:
  - apiGroups: [ "" ] # core API group
    resources: [ "services" ]
    verbs: [ "get", "list" ]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: hpcc-dali
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: hpcc-dali
subjects:
  - kind: ServiceAccount
    name: hpcc-dali
    namespace: {{ .Release.Namespace }}

# PR Title Validation
# ====================
# Ensures pull request titles start with "HPCC-" followed by digits
#
name: pr-title-check

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]
    branches:
      - "master"
      - "candidate-*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  validate-title:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Check PR title format
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "Checking PR title: $PR_TITLE"

          # Check if title starts with HPCC- (case sensitive) followed by digits
          if echo "$PR_TITLE" | grep -qE '^HPCC-[0-9]+'; then
            echo "✓ PR title is valid: starts with HPCC- followed by digits"
          else
            echo "✗ PR title is invalid"
            echo ""
            echo "PR titles must start with 'HPCC-' (case insensitive) followed by digits."
            echo "Examples:"
            echo "  ✓ HPCC-12345 Fix memory leak in Thor"
            echo "  ✗ hpcc-999 Update documentation"
            echo "  ✗ Fix memory leak"
            echo "  ✗ HPCC- Missing ticket number"
            exit 1
          fi

      - name: Check first commit message format and signature
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "Getting first commit in PR..."

          # Get the first commit in the PR
          FIRST_COMMIT=$(git rev-list --reverse ${BASE_SHA}..${HEAD_SHA} | head -n 1)

          if [ -z "$FIRST_COMMIT" ]; then
            echo "✗ Could not determine first commit"
            exit 1
          fi

          # Get the commit message (first line)
          COMMIT_MSG=$(git log --format=%s -n 1 "$FIRST_COMMIT")
          echo "First commit message: $COMMIT_MSG"

          # Get the full commit message body
          FULL_COMMIT_MSG=$(git log --format=%B -n 1 "$FIRST_COMMIT")

          # Check if commit message starts with HPCC- (case sensitive) followed by digits
          if echo "$COMMIT_MSG" | grep -qE '^HPCC-[0-9]+'; then
            echo "✓ First commit message is valid: starts with HPCC- followed by digits"
          else
            echo "✗ First commit message is invalid"
            echo ""
            echo "The first commit message must start with 'HPCC-' (case sensitive) followed by digits."
            echo "Examples:"
            echo "  ✓ HPCC-12345 Fix memory leak in Thor"
            echo "  ✓ HPCC-999: Update documentation"
            echo "  ✗ hpcc-999 Wrong case"
            echo "  ✗ Fix memory leak"
            echo "  ✗ HPCC- Missing ticket number"
            exit 1
          fi

          # ---- 1. DCO check ----
          DCO_OK=false
          if echo "$FULL_COMMIT_MSG" | grep -q "Signed-off-by: "; then
            echo "✓ DCO sign-off found"
            DCO_OK=true
          fi

          # ---- 2. GPG check ----
          GPG_OK=false
          if git log --format=%G? -n 1 "$FIRST_COMMIT" | grep -q "^G"; then
            echo "✓ GPG signature verified"
            GPG_OK=true
          fi

          # ---- Require at least ONE ----
          if [ "$DCO_OK" = "true" || "$GPG_OK" = "true" ]; then
            echo "First commit is signed (DCO or GPG)"
          else
            echo "✗ First commit is not signed"
            echo ""
            echo "You must sign the first commit **either** with:"
            echo "  • DCO: add a 'Signed-off-by:' line  →  git commit -s"
            echo "  • GPG: sign with your key          →  git commit -S"
            echo ""
            echo "To fix an existing commit:"
            echo "  git rebase -i ${BASE_SHA}^"
            echo "  Change 'pick' → 'edit' on the first commit, then:"
            echo "    git commit --amend -s   # for DCO"
            echo "    # or"
            echo "    git commit --amend -S --no-edit   # for GPG"
            echo "  git rebase --continue"
            exit 1
          fi

          exit 0

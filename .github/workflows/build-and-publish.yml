name: Build and publish
# This workflow is triggered on new tags of Community Edition 7.8.x or later,
# or any of the weekly tag names starting 'master'
on:
  push:
    tags:
    - 'master*'
    - 'community_*'
    - '!community_7.6.*'
    - '!community_7.4.*'
    - '!community_7.2.*'
    - '!community_7.0.*'
    - '!community_6.*'

jobs:
  build:
    name: "Build and publish release container"
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build
        uses: ./dockerfiles
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          latest: 1   # this should only be set on the current minor branch
          docker_repo: ${{ secrets.IMAGE_REPOSITORY }}
          build_user: ${{ secrets.LNB_ACTOR }}
          github_actor: ${{ secrets.LNB_ACTOR }}
          github_token: ${{ secrets.LNB_TOKEN }}
          sign_modules: "OFF"
          signing_secret: ${{ secrets.SIGNING_SECRET }}
          signing_keyid: ${{ secrets.SIGNING_KEYID }}
          signing_passphrase: ${{ secrets.SIGNING_PASSPHRASE }}

  # ml-builds:
  #   needs: build
  #   runs-on: ubuntu-20.04
  #   strategy:
  #     matrix:
  #       engine: ['ml', 'gnn', 'gnn-gpu']
  #   steps:
  #   - name: Checkout
  #     uses: actions/checkout@v2
  #   - name: Build
  #     uses: ./dockerfiles
  #     with:
  #       username: ${{ secrets.DOCKER_USERNAME }}
  #       password: ${{ secrets.DOCKER_PASSWORD }}
  #       latest: 1   # this should only be set on the current minor branch
  #       build_ml: ${{ matrix.engine }}
  #       docker_repo: ${{ secrets.IMAGE_REPOSITORY }}
  #       build_user: ${{ secrets.LNB_ACTOR }}
  #       github_actor: ${{ secrets.LNB_ACTOR }}
  #       github_token: ${{ secrets.LNB_TOKEN }}

  ln-builds:
    needs: build
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Build
      uses: ./dockerfiles
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        docker_repo: ${{ secrets.IMAGE_REPOSITORY }}
        ln_username: ${{ secrets.LN_IMAGE_USERNAME }} # for image repo
        ln_password: ${{ secrets.LN_IMAGE_PASSWORD }} # for image repo
        ln_registry: ${{ secrets.LN_IMAGE_REGISTRY }} # for image repo
        ln_docker_repo: ${{ secrets.LN_IMAGE_REPOSITORY }} # for image repo
        lnb_token: ${{ secrets.LNB_TOKEN }} # for github
        latest: 1   # this should only be set on the current minor branch
        build_ln: 1
        build_user: ${{ secrets.LNB_ACTOR }}
        github_actor: ${{ secrets.LNB_ACTOR }}
        github_token: ${{ secrets.LNB_TOKEN2 }}
        sign_modules: "OFF"
        signing_secret: ${{ secrets.SIGNING_SECRET }}
        signing_keyid: ${{ secrets.SIGNING_KEYID }}
        signing_passphrase: ${{ secrets.SIGNING_PASSPHRASE }}

import{_ as t,a as s,o as n,ag as i}from"./chunks/framework.Do1Zayaf.js";const g=JSON.parse('{"title":"ECL Redis Plugin","description":"","frontmatter":{},"headers":[],"relativePath":"plugins/redis/README.md","filePath":"plugins/redis/README.md","lastUpdated":1761843274000}'),a={name:"plugins/redis/README.md"};function o(r,e,l,d,c,h){return n(),s("div",null,e[0]||(e[0]=[i(`<h1 id="ecl-redis-plugin" tabindex="-1">ECL Redis Plugin <a class="header-anchor" href="#ecl-redis-plugin" aria-label="Permalink to &quot;ECL Redis Plugin&quot;">​</a></h1><p>This is the ECL plugin to utilize the persistent key-value cache <a href="http://redis.io" target="_blank" rel="noreferrer">Redis</a>. It utilises the C API <a href="http://github.com/redis/hiredis" target="_blank" rel="noreferrer">hiredis</a>.</p><h2 id="installation-and-dependencies" tabindex="-1">Installation and Dependencies <a class="header-anchor" href="#installation-and-dependencies" aria-label="Permalink to &quot;Installation and Dependencies&quot;">​</a></h2><p>To build the redis plugin with the HPCC-Platform, libhiredis-dev is required.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>sudo apt-get install libhiredis-dev</span></span></code></pre></div><p>The redis server and client software can be obtained via either - <a href="http://redis.io/download" target="_blank" rel="noreferrer">binaries</a>, <a href="https://github.com/antirez/redis" target="_blank" rel="noreferrer">source</a> or the preferred method:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>sudo apt-get install redis-server</span></span></code></pre></div><p><em>Note:</em> redis-server 2.6.12 or greater is required to use this plugin as intended. For efficiency, such version requirements are not checked as this is a runtime check only. The use of a lesser version will result in an exception, normally indicating that either a given command does not exist or that the wrong number of arguments was passed to it. The Set&lt;type&gt; plugin functions will not work when setting with an expiration for a version less than 2.6.12. In addition, whilst it is possible to use <code>Expire</code> with a version less than 2.1.3 it is not advised due to <a href="http://redis.io/commands/expire" target="_blank" rel="noreferrer">the change in its semantics</a>.</p><p><em>Note:</em> The minimum version requirement for the API hiredis to allow for redis connections to be cached is 0.13.0.</p><h2 id="getting-started" tabindex="-1">Getting started <a class="header-anchor" href="#getting-started" aria-label="Permalink to &quot;Getting started&quot;">​</a></h2><p>The server can be started by typing <code>redis-server</code> within a terminal. To run with a non-default configuration run as <code>redis-server redis.conf</code>, where redis.conf is the configuration file supplied with the redis-server package.</p><p>For example, to require the server to <strong>password authenticate</strong>, locate and copy redis.conf to a desired dir. Then locate and alter the &#39;requirepass&#39; variable within the file. Similarly the server <strong>port</strong> can also be altered here. <em>Note:</em> that the default is 6379 and that if multiple and individual caches are required then they are by definition redis-servers on different ports.</p><p>The <strong>redis-server</strong> package comes with the redis client <strong>redis-cli</strong>. This can be used to send and receive commands to and from the server, invoked by <code>redis-cli</code> or, for example, <code>redis-cli -p 6380</code> to connect to the redis-cache on port 6380 (assuming one has been started).</p><p>Perhaps one of the most handy uses of <strong>redis-cli</strong> is the ability to monitor all commands issued to the server via the redis command <code>MONITOR</code>. <code>INFO ALL</code> is also a useful command for listing the server and cache settings and statistics. <em>Note:</em> that if <strong>requirepass</strong> is activated <strong>redis-cli</strong> with require you to authenticate via <code>AUTH \\&lt;passcode\\&gt;</code>.</p><p>Further <a href="http://redis.io/documentation" target="_blank" rel="noreferrer">documentation</a> is available with a full list of redis <a href="http://redis.io/commands" target="_blank" rel="noreferrer">commands</a>.</p><h2 id="the-actual-plugin" tabindex="-1">The Actual Plugin <a class="header-anchor" href="#the-actual-plugin" aria-label="Permalink to &quot;The Actual Plugin&quot;">​</a></h2><p>The bulk of this redis plugin for <strong>ECL</strong> is made up of the various <code>SET</code> and <code>GET</code> commands e.g. <code>GetString</code> or <code>SetReal</code>. They are accessible via the module <code>redis</code> from the redis plugin <strong>ECL</strong> <a href="https://github.com/hpcc-systems/HPCC-Platform/blob/master/plugins/redis/lib_redis.ecllib" target="_blank" rel="noreferrer">library</a> <code>lib-redis</code>. i.e.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>IMPORT redis FROM lib_redis;</span></span></code></pre></div><p>Here is a list of the core plugin <strong>functions</strong>.</p><p>###Set</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SetUnicode( CONST VARSTRING key, CONST UNICODE value, CONST VARSTRING options, INTEGER4 database = 0, UNSIGNED4 expire = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>SetString(  CONST VARSTRING key, CONST STRING value,  CONST VARSTRING options, INTEGER4 database = 0, UNSIGNED4 expire = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>SetUtf8(    CONST VARSTRING key, CONST UTF8 value,    CONST VARSTRING options, INTEGER4 database = 0, UNSIGNED4 expire = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>SetBoolean( CONST VARSTRING key, BOOLEAN value,       CONST VARSTRING options, INTEGER4 database = 0, UNSIGNED4 expire = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>SetReal(    CONST VARSTRING key, REAL value,          CONST VARSTRING options, INTEGER4 database = 0, UNSIGNED4 expire = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>SetInteger( CONST VARSTRING key, INTEGER value,       CONST VARSTRING options, INTEGER4 database = 0, UNSIGNED4 expire = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>SetUnsigned(CONST VARSTRING key, UNSIGNED value,      CONST VARSTRING options, INTEGER4 database = 0, UNSIGNED4 expire = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>SetData(    CONST VARSTRING key, CONST DATA value,    CONST VARSTRING options, INTEGER4 database = 0, UNSIGNED4 expire = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span></code></pre></div><p>###Get</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>INTEGER8   GetInteger(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>UNSIGNED8 GetUnsigned(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>STRING      GetString(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>UNICODE    GetUnicode(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>UTF8          GetUtf8(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>BOOLEAN    GetBoolean(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>REAL          GetReal(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>DATA          GetData(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span></code></pre></div><p>###Numeric</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>INTEGER8 INCRBY(CONST VARSTRING key, INTEGER8 value = 1, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span></code></pre></div><p>###Utility</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>BOOLEAN Exists(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000)</span></span>
<span class="line"><span>FlushDB(CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>Delete(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>Persist(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>Expire(CONST VARSTRING key, CONST VARSTRING options, INTEGER4 database = 0, UNSIGNED4 expire, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>INTEGER DBSize(CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN cacheConnections = TRUE)</span></span></code></pre></div><p>###PUB-SUB</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>UNSIGNED Publish(CONST VARSTRING keyOrChannel, CONST STRING message, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN lockedKey = FALSE, BOOLEAN cacheConnections = TRUE)</span></span>
<span class="line"><span>STRING Subscribe(CONST VARSTRING keyOrChannel, CONST VARSTRING options, INTEGER4 database = 0, CONST VARSTRING password = &#39;&#39;, UNSIGNED4 timeout = 1000, BOOLEAN lockedKey = FALSE, BOOLEAN cacheConnections = TRUE)</span></span></code></pre></div><p>The core points to note here are:</p><ul><li>There is a <strong>SET</strong> and <strong>GET</strong> function associated with each fundamental <strong>ECL</strong> type. These must be used for and with their correct <em>value</em> types! Miss-use <em>should</em> result in an runtime exception, however, this is only conditional on having the value retrieved from the server fitting into memory of the requested type. E.g. it is possible for a STRING of length 8, set with SetString, being successfully retrieved from the cache via GetInteger without an <strong>ECL</strong> exception being thrown.</li><li><code>CONST VARSTRING options</code> passes the server <strong>IP</strong> and <strong>port</strong> to the plugin in the <em>strict</em> format - <code>--SERVER=\\&lt;ip\\&gt;:\\&lt;port\\&gt;</code>. If <code>options</code> is empty, the default 127.0.0.1:6379 is used. <em>Note:</em> 6379 is the default port for <strong>redis-server</strong>.</li><li><code>UNSIGNED4 timeout</code> has units <em>ms</em> and has a default value of 1 second (0 := infinity). <em>c.f.</em> &#39;Timeout Values&#39; below for advice on choosing appropriate values.</li><li><code>UNSIGNED expire</code> has units <em>ms</em> and a default of <strong>0</strong>, i.e. <em>forever</em>.</li><li>Both <code>Publish</code> and <code>Subscribe</code> have a flag <code>BOOLEAN lockedKey = FALSE</code> such, that when <strong>TRUE</strong>, will encode <code>CONST VARSTRING keyOrChannel</code> as if it were a key allowing key-channel encoding compatibility with the <code>GetOrLockString</code> and <code>SetAndPublishString</code> functions. For this reason, they both also take a <strong>Database</strong> value as this is used in the encoding of the lock and channel. Please note however that the redis pub-sub paradigm is actually irrespective of database.</li><li><em>c.f.</em> redis documentation for the following - <a href="http://redis.io/commands/exists" target="_blank" rel="noreferrer">Exists</a>, <a href="http://redis.io/commands/flushdb" target="_blank" rel="noreferrer">FlushDB</a>, <a href="http://redis.io/commands/del" target="_blank" rel="noreferrer">Delete</a>, <a href="http://redis.io/commands/persist" target="_blank" rel="noreferrer">Persist</a>, <a href="http://redis.io/commands/expire" target="_blank" rel="noreferrer">Expire</a>, <a href="http://redis.io/commands/dbsize" target="_blank" rel="noreferrer">DBSize</a>, <a href="http://redis.io/commands/publish" target="_blank" rel="noreferrer">Publish</a>, &amp; <a href="http://redis.io/commands/subscribe" target="_blank" rel="noreferrer">Subscribe</a>.</li></ul><p>###Connection Caching</p><p>To prevent unnecessary opening and closing of connections between subsequent functions calls, these connections are cached and reused. This is only true if the said connection is free of errors, otherwise it is closed and a new one opened. There are three cached instances per thread, storing a single connection for subscriptions, publishes, and then one for everything else. The caching of connections is only possible for versions of hiredis greater than the minimum version noted in the section <strong>Installation and Dependencies</strong>. The caching can be turned <strong>ON</strong> and <strong>OFF</strong> on a per function basis using the <code>cacheConnections</code> boolean passed as a function parameter. In addition, the following system environment setting <code>HPCC_REDIS_PLUGIN_CONNECTION_CACHING_LEVEL</code> can be set to:</p><ul><li><code>0</code> - force any &amp; all caching <strong>OFF</strong></li><li><code>1</code> - allow caching of connections <strong>(default)</strong>.</li><li><code>2</code> - force any &amp; all caching <strong>ON</strong>.</li><li><code>&lt; 0 and &lt; 2</code> - undefined.</li></ul><p>This environment variable must be set for the user group <strong>hpcc</strong> and can be done by editing /etc/profile (service restart required).</p><p>Regarding the caching of connections used purely for subscriptions, it is essential that they are successfully unsubscribed before being reused. Such an attempt to unsubscribe and confirm this, is limited in effort to do so, otherwise giving up and simply closing the connection and opening a new one. To aid in the tuning of this for both payload and system/network constraints, the following three system environment settings exist:</p><ul><li><code>HPCC_REDIS_PLUGIN_CACHE_SUB_CONNECTIONS</code> - turn the caching of subscription connections <strong>ON</strong> or <strong>OFF</strong>. <strong>Default = ON</strong></li><li><code>HPCC_REDIS_PLUGIN_UNSUBSCRIBE_READ_ATTEMPTS</code> - the maximum number of socket reads to attempt to receive the required unsubscribe confirmation before giving up. <strong>Default = 2</strong>.</li><li><code>HPCC_REDIS_PLUGIN_UNSUBSCRIBE_TIMEOUT</code> - the timeout value (ms) used for such socket reads. <strong>Default = 100</strong>.</li></ul><p><em>Note:</em> For further implementation details refer to the comment associated with the definition of SubConnection::unsubscribe(...) in HPCC-Platform/plugins/redis/redis.cpp.</p><p>###The redisServer MODULE To avoid the cumbersome and unnecessary need to constantly pass <code>options</code>, <code>password</code>, <code>timeout</code>, and <code>cacheConnections</code> with each function call, the module <code>redisServer</code> can be imported to effectively <em>wrap</em> the above functions.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>IMPORT redisServer FROM lib_redis;</span></span>
<span class="line"><span>myRedis := redisServer(&#39;--SERVER=127.0.0.1:6379&#39;, &#39;foobared&#39;, 2000, FALSE);</span></span>
<span class="line"><span>myRedis.SetString(&#39;myKey&#39;, &#39;supercalifragilisticexpialidocious&#39;);</span></span>
<span class="line"><span>myRedis.GetString(&#39;myKey&#39;);</span></span></code></pre></div><p>###A Redis &#39;Database&#39; The notion of a <em>database</em> within a redis cache is that of a partition, such that it may contain an identical key per database e.g.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>myRedis.SetString(&#39;myKey&#39;, &#39;foo&#39;, 0);</span></span>
<span class="line"><span>myRedis.SetString(&#39;myKey&#39;, &#39;bar&#39;, 1);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>myRedis.GetString(&#39;myKey&#39;, 0);//returns &#39;foo&#39;</span></span>
<span class="line"><span>myRedis.GetString(&#39;myKey&#39;, 1);//returns &#39;bar&#39;</span></span></code></pre></div><p><em>Note:</em> that the default database is 0. The maximum number of databases allowed by <strong>Redis</strong> is 2147483647 (int32).</p><h2 id="race-retrieval-and-locking-keys" tabindex="-1">Race Retrieval and Locking Keys <a class="header-anchor" href="#race-retrieval-and-locking-keys" aria-label="Permalink to &quot;Race Retrieval and Locking Keys&quot;">​</a></h2><p>A common use of external caching systems such as <strong>redis</strong> is for temporarily storing data that may be expensive, computationally or otherwise, to obtain and thus doing so <em>only once</em> is paramount. In such a scenario it is possible (in cases usual) for multiple clients/requests to <em>hit</em> the cache simultaneously and upon finding that the data requested has not yet been stored, it is desired that only one of such requests obtain the new value and then store it for the others to then also obtain (from the cache). This plugin offers a solution to such a problem via the <code>GetOrLock</code> and <code>SetAndPublish</code> functions within the <code>redisServer</code> and <code>redis</code> modules of lib_redis. This module contains only three function categories - the <code>SET</code> and <code>GET</code> functions for <strong>STRING</strong>, <strong>UTF8</strong>, and <strong>UNICODE</strong> (i.e. only those that return empty strings) and lastly, an auxiliary function <code>Unlock</code> used to manually unlock locked keys as it be discussed.</p><p>The principle here is based around a <em>cache miss</em> in which a requested key does not exist, the first requester (<em>race winner</em>) &#39;locks&#39; the key in an atomic fashion. Any other simultaneous requester (<em>race loser</em>) finds that the key exists but has been locked and thus <strong>SUBSCRIBES</strong> to the key awaiting a <strong>PUBLICATION</strong> message from the <em>race-winner</em> that the value has been set. Such a paradigm is well suited by redis due to its efficiently implemented <strong>PUB-SUB</strong> infrastructure.</p><p>###An ECL Example</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">IMPORT redisServer FROM lib_redis</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">myRedis :</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> redisServer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;--SERVER=127.0.0.1:6379&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">STRING poppins :</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;supercalifragilisticexpialidocious&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> //Value to externally compute/retrieve from 3rd party vendor.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">myFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(STRING </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, INTEGER4 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">database</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) :</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FUNCTION</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  //Function for computing/retrieving a value.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> myRedis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GetString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, database);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">END;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SEQUENTIAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    myRedis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SetString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;poppins&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, poppins, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //If the key does not exist it will &#39;lock&#39; the key and retrun an empty STRING.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    STRING value :</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> myRedis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GetOrLockString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;supercali- what?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //All SetAndPublish\\&lt;type\\&gt;() return the value passed in as the 2nd parameter.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LENGTH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, myRedis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SetAndPublishString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;supercali- what?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">myFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;poppins&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)), value);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span></code></pre></div><p><em>Note:</em> further <strong>ECL</strong> examples can be found in the following files regarding the <a href="https://github.com/hpcc-systems/HPCC-Platform/blob/master/testing/regress/ecl/redislockingtest.ecl" target="_blank" rel="noreferrer">locking</a> and <a href="https://github.com/hpcc-systems/HPCC-Platform/blob/master/testing/regress/ecl/redissynctest.ecl" target="_blank" rel="noreferrer">non-locking</a> functions.</p><p>###Timeout Values The timeout durations are effectively for the entire duration of a call to each of the functions exported by this plugin library. By &#39;effectively&#39;, it is meant that a timer is initiated at the start of each call and upon each internal communication with the redis server, any time remaining (at this point) is the timeout value passed to the redis API (hiredis) for that communication call. Since some plugin functions make more calls to the server than others (<em>c.f.</em> &#39;Behaviour and Implementation Details&#39; below) it is possible for those functions with more server calls to timeout more regularly than those with less. To avoid this, it is advised to set the timeouts to a multiple of the anticipated latency of the client-server-IO, where such multiple should be at least the maximum expected number of internal redis calls made by these plugin functions, e.g. 12.</p><p>When using the <strong>ECL</strong> pattern described in the above section <em>An ECL Example</em>, it is required to set the timeout and lock expiration to be equal to the timeout (if any) of <code>myFunc</code> <strong>+</strong> that passed to <code>SetAndPublish\\&lt;type\\&gt;</code>, such that both the lock and waiting subscribers live long enough for a value to be set/published.</p><p>It should also be noted that, whilst it is possible to set different values for <code>timeout</code> and <code>expire</code> to the function <code>GetOrLock\\&lt;type\\&gt;</code>, it is advisable not to. This is such that the lock does not out live all waiting subscribers that collectively timeout and thus not blocking any subsequent retries of the locking pattern.</p><h2 id="behaviour-and-implementation-details" tabindex="-1">Behaviour and Implementation Details <a class="header-anchor" href="#behaviour-and-implementation-details" aria-label="Permalink to &quot;Behaviour and Implementation Details&quot;">​</a></h2><p>A few notes to point out here:</p><ul><li>PUB-SUB channels are not disconnected from the keyspace as they are in their native redis usage. The key itself is used as the lock with its value being set as the channel to later PUBLISH on or SUBSCRIBE to. This channel is a string, unique by only the <em>key</em> and <em>database</em>, prefixed with <strong>&#39;redis_ecl_lock&#39;</strong>. E.g. the <em>key</em> &#39;myKey&#39; designated for <em>database</em> 1, will have the following lock id - &#39;redis_ecl_lock_myKey_1&#39;.</li><li>It is possible to manually &#39;unlock&#39; this lock (<code>DELETE</code> the key) via the <code>Unlock(\\&lt;key\\&gt;)</code> function. <em>Note:</em> this function will fail on any communication or reply error however, it will <strong>silently fail</strong>, leaving the lock to expire, if the server observes any change to the key during the function call duration.</li><li>When the <em>race-winner</em> publishes, it actually publishes the value itself and that any subscriber will then obtain the key-value in this fashion. Therefore, not requiring an additional <code>GET</code> and possible further race conditions in doing so. <em>Note:</em> This does however, mean that it is possible for the actual redis <code>SET</code> to fail on one client/process, have the key-value received on another, and yet, the key-value still does not exist on the cache.</li><li>At present the &#39;lock&#39; is not as such an actual lock, as only the locking functions acknowledge it. By current implementation it is better thought as a flag for <code>GET</code> to wait and subscribe. I.e. the locked key can be deleted and re-set just as any other key can be.</li><li>Below is a table of the number of calls to the redis server for each of the plugin functions (or categories of) including the maximum possible and nominal expected, where the latter is due to using a cached connection, i.e. neither the server IP, port, nor password have changed from the function called prior to the one in question.</li></ul><table tabindex="0"><thead><tr><th style="text-align:left;">Operation/Function</th><th style="text-align:center;">Nominal</th><th style="text-align:center;">Maximum</th><th style="text-align:right;">Diff due to...</th></tr></thead><tbody><tr><td style="text-align:left;">A new connection</td><td style="text-align:center;">3</td><td style="text-align:center;">4</td><td style="text-align:right;">database</td></tr><tr><td style="text-align:left;">Cached connection</td><td style="text-align:center;">0</td><td style="text-align:center;">2</td><td style="text-align:right;">database, timeout</td></tr><tr><td style="text-align:left;">Get&lt;type&gt;</td><td style="text-align:center;">1</td><td style="text-align:center;">5</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">Set&lt;type&gt;</td><td style="text-align:center;">1</td><td style="text-align:center;">5</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">FlushDB</td><td style="text-align:center;">1</td><td style="text-align:center;">5</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">Delete</td><td style="text-align:center;">1</td><td style="text-align:center;">5</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">Persist</td><td style="text-align:center;">1</td><td style="text-align:center;">5</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">Exists</td><td style="text-align:center;">1</td><td style="text-align:center;">5</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">DBSize</td><td style="text-align:center;">1</td><td style="text-align:center;">5</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">Expire</td><td style="text-align:center;">1</td><td style="text-align:center;">5</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">GetOrLock</td><td style="text-align:center;">7</td><td style="text-align:center;">11</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">GetOrLock (locked)</td><td style="text-align:center;">8</td><td style="text-align:center;">12</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">SetAndPublish (value length &gt; 29)</td><td style="text-align:center;">1</td><td style="text-align:center;">5</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">SetAndPublish (value length &lt; 29)</td><td style="text-align:center;">4</td><td style="text-align:center;">8</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">Unlock</td><td style="text-align:center;">5</td><td style="text-align:center;">9</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">Publish</td><td style="text-align:center;">1</td><td style="text-align:center;">4</td><td style="text-align:right;">new connection</td></tr><tr><td style="text-align:left;">Subscribe</td><td style="text-align:center;">5</td><td style="text-align:center;">5</td><td style="text-align:right;">new connection always needed</td></tr></tbody></table>`,56)]))}const u=t(a,[["render",o]]);export{g as __pageData,u as default};

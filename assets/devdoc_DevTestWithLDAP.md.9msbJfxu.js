import{_ as t,a,o as s,ag as i}from"./chunks/framework.Do1Zayaf.js";const u=JSON.parse('{"title":"Overview","description":"","frontmatter":{},"headers":[],"relativePath":"devdoc/DevTestWithLDAP.md","filePath":"devdoc/DevTestWithLDAP.md","lastUpdated":1771585025000}'),o={name:"devdoc/DevTestWithLDAP.md"};function n(r,e,l,d,h,c){return s(),a("div",null,e[0]||(e[0]=[i('<h1 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h1><p>These directions walk through the steps to configure and setup, from scratch, an out-of-the-box HPCC platform deployment using LDAP authentication.</p><p>The goal is for developers and other technical platform users to have available an LDAP Directory Server (DS) server they can use for testing and troubleshooting authentication and authorization features. These directions don&#39;t cover the steps needed for securing a production-grade DS instance and the communication between it and the platform components. Any deployment with this setup should be ephemeral, publicly unreachable, and not have access to sensitive data.</p><p>First we will set up a Docker container with a minimal 389ds LDAP Directory Server and a phpLdapAdmin (PLA) client to administer it. The PLA can be used to inspect your DS and perform any administrative tasks not supported by the ECL Watch client.</p><p>Then we&#39;ll cover the configuration changes to deploy a minimal HPCC platform, both non-containerized (bare-metal) and under Kubernetes, that uses 389ds for security.</p><h2 id="initial-state" tabindex="-1">Initial State <a class="header-anchor" href="#initial-state" aria-label="Permalink to &quot;Initial State&quot;">​</a></h2><p>When the platform launches it ensures the LDAP DS is initialized with the base DN (distinguished name) and OUs (organizational units) needed. Among others, OUs for groups, users and ESP authorization resources are created. If present in the config, an HPCC Admin user is created, and added to the administrator&#39;s group.</p><p>If you need any other security settings beyond that, such as non-administrative users and groups, you&#39;ll need to create them using ECL Watch. The administrator account itself has the privileges to make these kinds of changes. You may see that the admin doesn&#39;t by default have <em>all</em> permissions, but it can add any it needs to the admin group.</p><p>This setup has been tested with ECL Watch authentication and authorization. It should also work for file and workunit scopes, but that hasn&#39;t been confirmed.</p><p>Your customized setup will be saved to a persistent volume, and you can separately maintain different versions as needed.</p><h1 id="docker-ldap-directory-service-and-admin-setup" tabindex="-1">Docker LDAP Directory Service and Admin Setup <a class="header-anchor" href="#docker-ldap-directory-service-and-admin-setup" aria-label="Permalink to &quot;Docker LDAP Directory Service and Admin Setup&quot;">​</a></h1><p>We&#39;ll run our 389ds and PLA in a Docker container launched from platform source: <code>dockerfiles/examples/ldap</code>.</p><p>These instructions create a persistent volume for the DS inside your directory, but you can customize the docker-compose file to use another location. All of the server state is stored in the mounted volume, so if you want to be able to easily switch between different configurations you can easily do so by switching the mounted directory at launch.</p><ol><li><p>Copy the <code>dockerfiles/examples/ldap</code> folder to a location outside of your repo, say <code>${HOME}/ldap</code>. Edit the file <code>${HOME}/ldap/docker-compose.yaml</code>, customizing the admin password and PVC mount point:</p><ul><li>Change <code>DS_DM_PASSWORD: &quot;&lt;directory_manager_pw&gt;&quot;</code> placeholder with the real password you want to use. This is the password that you will use in PLA to administer the DS, and that the HPCC platform will use to interact with it using LDAP.</li><li>Under volumes, replace <code>${HOME}/389ds</code> with the location of your choice.</li></ul></li><li><p>From <code>${HOME}/ldap</code>, run:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> up</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span></span></code></pre></div></li><li><p>Create the LDAP backend (suffix) on the Directory Server. This configures the server to manage the <code>dc=example,dc=com</code> naming context. This step should be done only once, the first time you run the container with a new directory mounted:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 389ds</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/dsconf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backend</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --suffix</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dc=example,dc=com</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --be-name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> userRoot</span></span></code></pre></div><p><strong>What this does:</strong> The <code>dsconf backend create</code> command configures the LDAP server to manage a specific DN subtree (in this case <code>dc=example,dc=com</code>). This is a server-side configuration that tells 389 Directory Server &quot;I will handle queries for this naming context,&quot; but it does <strong>not</strong> create any actual directory entries yet.</p></li><li><p>Verify the backend was created successfully. You should see the response &quot;The database was successfully created&quot;. You can also verify by checking that files were created in your mounted volume (<code>${HOME}/389ds</code> or your configured path from <code>${HOME}/ldap/docker-compose.yaml</code>), or by running this command and confirming that <code>dc=example,dc=com</code> is listed:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 389ds</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/dsconf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backend</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> suffix</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> list</span></span></code></pre></div><p><strong>Note:</strong> At this point, phpLDAPadmin will not yet be able to browse the directory tree because the base DN entry itself doesn&#39;t exist. Only the server configuration has been set up.</p></li><li><p>Initialize the LDAP directory structure by running HPCC Platform for the first time. Before using phpLDAPadmin to manage the directory, you must start the HPCC Platform at least once (see sections below for bare-metal or containerized setup). On first startup, the platform will:</p><ul><li>Detect that the base DN entry (<code>dc=example,dc=com</code>) is missing</li><li>Automatically create the base DN entry and all necessary organizational units (OUs) for users, groups, and resources</li><li>Initialize the HPCCAdministrators group if it is a relative path</li><li>Add an admin user if present in the config</li></ul><p>After the platform has initialized the directory structure, you can verify and manage your LDAP server using phpLDAPadmin at <code>http://localhost:8080</code>. Login with:</p><ul><li><strong>username:</strong> <code>cn=Directory Manager</code></li><li><strong>password:</strong> <code>&lt;directory_manager_pw&gt;</code> (as configured in docker-compose.yaml)</li></ul><p>You should now see the complete directory tree including <code>dc=example,dc=com</code> and all HPCC-created organizational units.</p></li></ol><h2 id="fresh-start-or-multiple-servers" tabindex="-1">Fresh Start or Multiple Servers <a class="header-anchor" href="#fresh-start-or-multiple-servers" aria-label="Permalink to &quot;Fresh Start or Multiple Servers&quot;">​</a></h2><p>Assuming stock values from our example, the state for the Directory Server is stored <code>${HOME}/389ds</code>. If you want to wipe out your server and start fresh, delete the contents of <code>${HOME}/389ds</code> and begin again with the setup above from step 2.</p><p>If you&#39;d like to create an additional server with different settings, then:</p><ol start="6"><li><p>Copy the <code>dockerfiles/examples/ldap</code> folder to a location outside of your repo to a new unique location, say <code>${HOME}/ldap-alternate</code>. Edit the file <code>${HOME}/ldap-alternate/docker-compose.yaml</code>, customizing the admin password and PVC mount point:</p><ul><li>Change <code>DS_DM_PASSWORD: &quot;&lt;directory_manager_pw&gt;&quot;</code> placeholder with the real password you want to use. This is the password that you will use in PLA to administer the DS, and that the HPCC platform will use to interact with it using LDAP.</li><li>Under volumes, replace <code>${HOME}/389ds</code> with another new unique folder to hold the server state, say <code>${HOME}/389ds-alternate</code>.</li></ul></li><li><p>From <code>${HOME}/ldap-alternate</code>, run:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> up</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span></span></code></pre></div></li></ol><p>Then continue with steps 3-5 above, substituting your new <code>ldap-alternate</code> and <code>389ds-alternate</code> locations where appropriate. Now you have a second instance you can run instead of the first and its state is stored in the <code>389ds-alternate</code> folder.</p><h1 id="bare-metal-platform-docker-ldap-setup" tabindex="-1">Bare-Metal Platform + Docker LDAP Setup <a class="header-anchor" href="#bare-metal-platform-docker-ldap-setup" aria-label="Permalink to &quot;Bare-Metal Platform + Docker LDAP Setup&quot;">​</a></h1><p>These directions assume you&#39;re starting with a vanilla configuration from a fresh install or build. If you&#39;re not, then adjust the component names to match your config.</p><h2 id="configure-the-platform" tabindex="-1">Configure the Platform <a class="header-anchor" href="#configure-the-platform" aria-label="Permalink to &quot;Configure the Platform&quot;">​</a></h2><ol><li>Create LDAP Server Process, keeping the default name &quot;ldapserver&quot; <ul><li>Navigate to the Attributes tab and change these properties: <ul><li><code>adminGroupName = HPCCAdministrators</code></li><li><code>serverType = 389DirectoryServer</code></li><li><code>modulesBasedn = ou=SMC,ou=espservices,ou=ecl</code></li><li><code>systemBasedn = ou=example,ou=com</code></li><li><code>systemCommonName = Directory Manager</code></li><li><code>systemPassword = &lt;directory_manager_pw&gt;</code></li><li><code>systemUser = Directory Manager</code></li></ul></li><li>Navigate to the Instances tab: <ul><li>Add an instance on: <ul><li><code>computer = localhost</code></li><li><code>netAddress = .</code></li></ul></li></ul></li></ul></li><li>In the component &quot;Esp - myesp&quot;, navigate to the Authentication tab and change these properties: <ul><li><code>ldapServer = ldapserver</code></li><li><code>method = ldap</code></li></ul></li><li>Hand-edit the active <code>environment.xml</code> file. Find the <code>&lt;LDAPServerProcess&gt;</code> element and add the attribute <code>hpccAdminSecretKey=&quot;myhpccadminsecretkey&quot;</code></li></ol><h3 id="notes" tabindex="-1">Notes <a class="header-anchor" href="#notes" aria-label="Permalink to &quot;Notes&quot;">​</a></h3><ul><li><code>systemCommonName</code> and <code>systemUser</code> must match and they must match the name of the &#39;admin&#39; account of the 389ds server. By default this is &quot;Directory Manager&quot;.</li><li>The <code>modulesBasedn</code> is changed here to match the location in the DS where the SmcAccess permission is located. On initialization the secmgr creates the HPCC Admin and gives it SmcAccess to be able to login to ECL Watch.</li><li><code>adminGroupName</code> value affects where the group is created in the DS hierarchy, so don&#39;t use the special values &quot;Administrators&quot; or &quot;Directory Administrators&quot; unless you know that&#39;s what you need. The suggested value &quot;HPCCAdministrators&quot; will work well for development and testing.</li><li><code>systemBasedn</code> is the root of the DS tree used by the platform. It must match the backend suffix used in step #3 when configuring the 389ds server.</li><li><code>systemPassword</code> must match the 389ds <code>DS_DM_PASSWORD</code> configured in the <code>dockerfiles/examples/ldap/docker-compose.yaml</code> file.</li></ul><h2 id="add-secret-for-hpcc-admin-user" tabindex="-1">Add Secret for HPCC Admin User <a class="header-anchor" href="#add-secret-for-hpcc-admin-user" aria-label="Permalink to &quot;Add Secret for HPCC Admin User&quot;">​</a></h2><p>Next you must add the <code>myhpccadminsecretkey</code> to your HPCC platform deployment. If there are concerns about storing these credentials on disk you should remove this secret directory when not in use, or manage it with an encryption/decryption utility such as <code>gocryptfs</code></p><p>First note the root of your platform install location, which we&#39;ll refer to as <code>&lt;HPCC_ROOT&gt;</code>. Package installs will be rooted in <code>/</code> but dev installs are typically located at <code>$HOME/runtime</code>.</p><ol><li><p>Create all directories in this path if they don&#39;t already exist:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&lt;HPCC_ROOT&gt;/opt/HPCCSystems/secrets/authn/myhpccadminsecretkey</span></span></code></pre></div></li><li><p>Inside <code>myhpccadminsecretkey</code> create two text files with no extra whitespace and no terminal newline:</p><ul><li>A file named <code>username</code> containing <code>hpcc_admin</code></li><li>A file named <code>password</code> containing the password you want the hpcc admin user to have. We&#39;ll refer to it as <code>&lt;hpcc_admin_pw&gt;</code></li></ul></li></ol><h2 id="run-and-use-platform" tabindex="-1">Run and Use Platform <a class="header-anchor" href="#run-and-use-platform" aria-label="Permalink to &quot;Run and Use Platform&quot;">​</a></h2><ol><li><p>Start up the platform:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hpcc-init</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span></span></code></pre></div></li><li><p>Login to ECL Watch at <a href="http://127.0.0.1/8010" target="_blank" rel="noreferrer">http://127.0.0.1/8010</a> using the credentials:</p><ul><li>user: <code>hpcc_admin</code></li><li>password: <code>&lt;hpcc_admin_pw&gt;</code> (that you added to the secret above)</li></ul></li></ol><p>Initially your admin will only have SmcAccess, so you may see some access failure warnings, but you can navigate to the Topology | Security tab to customize the HPCCAdministrators permissions and add any other users, groups or permissions needed for testing. These warnings could also be due to permissions caching, and may be resolved after a platform restart.</p><h1 id="containerized-platform-docker-ldap" tabindex="-1">Containerized Platform + Docker LDAP <a class="header-anchor" href="#containerized-platform-docker-ldap" aria-label="Permalink to &quot;Containerized Platform + Docker LDAP&quot;">​</a></h1><p>This containerized deployment enables ldap auth for ECL Watch only, but it can be extended easily to other ESP services.</p><h2 id="create-k8s-secrets-for-platform" tabindex="-1">Create k8s Secrets for Platform <a class="header-anchor" href="#create-k8s-secrets-for-platform" aria-label="Permalink to &quot;Create k8s Secrets for Platform&quot;">​</a></h2><p>You&#39;ll need two k8s secrets, one for the HPCC administrator and another for the LDAP server administrator. Once created they&#39;ll persist in the Kubernetes backing store.</p><ol><li>Create secret for HPCC administrator:<div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secret</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> generic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> myhpccadminsecretkey</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --from-literal=username=hpcc_admin</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --from-literal=password=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">hpcc_admin_pw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div></li><li>Create secret for the LDAP server administrator:<div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secret</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> generic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> admincredssecretname</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --from-literal=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;username=Directory Manager&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --from-literal=password=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">directory_manager_pw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div></li></ol><h2 id="customize-platform-helm-values" tabindex="-1">Customize Platform Helm Values <a class="header-anchor" href="#customize-platform-helm-values" aria-label="Permalink to &quot;Customize Platform Helm Values&quot;">​</a></h2><p>We&#39;ll be using the customized Helm values file at <code>helm/examples/ldap/hpcc-values.yaml</code>. It will run all standard ESP services, but it uses ldap authentication only for the eclwatch service. Customize this file further as needed.</p><h3 id="notes-1" tabindex="-1">Notes <a class="header-anchor" href="#notes-1" aria-label="Permalink to &quot;Notes&quot;">​</a></h3><ul><li>The secrets values are case sensitive and must match what was created as k8s secrets. The supplied values work and match across instructions and files:</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    admincredsmountname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;admincredssecretname&quot;</span></span>\n<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    hpccadmincredsmountname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;myhpccadminsecretkey&quot;</span></span></code></pre></div><ul><li><code>systemBasedn</code> is the root of the DS tree used by the platform. It must match the backend suffix used in step #3 when <a href="#docker-ldap-directory-service-and-admin-setup">configuring the 389ds server</a>.</li><li>LDAP auth is only configured for the eclwatch service. Copy and paste the <code>auth</code> and <code>ldap</code> sections from there to any other ESP service you want to use ldap.</li></ul><h2 id="run-and-use-platform-1" tabindex="-1">Run and Use Platform <a class="header-anchor" href="#run-and-use-platform-1" aria-label="Permalink to &quot;Run and Use Platform&quot;">​</a></h2><p>Run from the root of your platform source, or provide an absolute path to the Helm values file used below.</p><ol><li>Start up the platform:</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mycluster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> hpcc/hpcc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> helm/examples/ldap/hpcc-values.yaml</span></span></code></pre></div><ol start="2"><li>Login to ECL Watch at <a href="http://127.0.0.1/8010" target="_blank" rel="noreferrer">http://127.0.0.1/8010</a> using the credentials: <ul><li>user: <code>hpcc_admin</code></li><li>password: <code>&lt;hpcc_admin_pw&gt;</code> Created in step <a href="#add-secret-for-hpcc-admin-user">Add secret for HPCC Admin user</a></li></ul></li></ol><p>Initially your admin will only have SmcAccess, so you may see some access failure warnings, but you can navigate to the Topology | Security tab to customize the HPCCAdministrators permissions and add any other users, groups or permissions needed for testing. These warnings could also be due to permissions caching, and may be resolved after a platform restart.</p>',49)]))}const m=t(o,[["render",n]]);export{u as __pageData,m as default};

import{_ as s,a,o as i,ag as n}from"./chunks/framework.Do1Zayaf.js";const E=JSON.parse('{"title":"FileRoxie/FilePuller/FileServer","description":"","frontmatter":{},"headers":[],"relativePath":"devdoc/Remote File Roxie.md","filePath":"devdoc/Remote File Roxie.md","lastUpdated":1771585025000}'),t={name:"devdoc/Remote File Roxie.md"};function l(r,e,p,o,h,d){return i(),a("div",null,e[0]||(e[0]=[n(`<p>This document outlines the best practices for deploying a roxie that uses remote storage.</p><h1 id="fileroxie-filepuller-fileserver" tabindex="-1">FileRoxie/FilePuller/FileServer <a class="header-anchor" href="#fileroxie-filepuller-fileserver" aria-label="Permalink to &quot;FileRoxie/FilePuller/FileServer&quot;">​</a></h1><p>There should be a &quot;File Roxie&quot; for each copy of the data that is being kept. The recommendation is to use a single-copy of the data using azure file ZRS storage. This means that the data is automatically available from any availability zone, and can be shared by all clusters that use that data.</p><p>Data is deployed to the roxie system by deploying a package map with the --dfu-copy option to use dfuserver to copy the data.</p><p>It is strongly recommended to configure the system to use the azure api to copy the files</p><ul><li>You do not need to configure and run dafilesrv instances (either on demand or up all the time)</li><li>It should be more efficient and quicker (verification needed)</li><li>This requires the data to be pulled directly from blob storage - so it should be pulled direct from thor, rather than from another roxie.</li></ul><p>If api copying is not possible then one of the following will be required:</p><ul><li>dafilesrv instances to spray data. Ideally these would be auto-scaled.</li><li>a classic pull roxie. The last resort - since the cost of standing one up is high.</li></ul><p>NOTE: This means that the FileServer dali is running in a single availability zone and is a single point of failure. The dali store should be on ZRS, and there should be a dormant mirror instance ready to start on demand to cover the case where an AZ goes down.</p><h1 id="deploying-environments" tabindex="-1">Deploying environments <a class="header-anchor" href="#deploying-environments" aria-label="Permalink to &quot;Deploying environments&quot;">​</a></h1><p>There should be a roxie environment for each set of roxie clusters that will be updated independently. For instance, if you had two classes of environments - general and restricted - each with multiple replicas - green, blue and yellow instances in different AZs then you would have 6 independent environments:</p><p>general green, general blue, general yellow, restricted green, restricted blue, restricted yellow</p><h2 id="architecture-diagram" tabindex="-1">Architecture Diagram <a class="header-anchor" href="#architecture-diagram" aria-label="Permalink to &quot;Architecture Diagram&quot;">​</a></h2><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    subgraph &quot;Thor Build Environment&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ThorDali[Dali Server&lt;br/&gt;on ZRS Storage]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Thor[Thor Cluster]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    subgraph &quot;Azure Blob Storage&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        BlobStorage[(Blob Storage)]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    subgraph &quot;File Server (Single AZ)&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        DaliFS[Dali Server&lt;br/&gt;on ZRS Storage]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        DaliMirror[Dormant Dali Mirror&lt;br/&gt;Backup Instance]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        DFU[DFU Server&lt;br/&gt;File Copy Service]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    subgraph &quot;Azure File Storage ZRS&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        FileStorage[(Shared File Storage&lt;br/&gt;Single Copy - All AZs)]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    subgraph &quot;General Environment&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        subgraph &quot;AZ1 - Green&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            DaliRG[Dali Server]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            RG1[Roxie Green&lt;br/&gt;Static/Dynamic Instances]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        subgraph &quot;AZ2 - Blue&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            RG2[Roxie Blue&lt;br/&gt;Static/Dynamic Instances]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        subgraph &quot;AZ3 - Yellow&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            RG3[Roxie Yellow&lt;br/&gt;Static/Dynamic Instances]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    subgraph &quot;Restricted Environment&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        subgraph &quot;AZ1 - Green&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            RR1[Roxie Green&lt;br/&gt;Static/Dynamic Instances]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        subgraph &quot;AZ2 - Blue&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            RR2[Roxie Blue&lt;br/&gt;Static/Dynamic Instances]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        subgraph &quot;AZ3 - Yellow&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            RR3[Roxie Yellow&lt;br/&gt;Static/Dynamic Instances]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Thor --&gt;|Uses| BlobStorage</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    BlobStorage -.-&gt;|API Copy&lt;br/&gt;Preferred| FileStorage</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    BlobStorage -.-&gt;|Alternative| DFU</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    DFU --&gt; FileStorage</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ThorDali --&gt; DaliFS</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ThorDali -.-&gt;|Manages| BlobStorage</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    DaliFS -.-&gt;|Manages| FileStorage</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    FileStorage --&gt; RG1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    FileStorage --&gt; RG2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    FileStorage --&gt; RG3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    FileStorage --&gt; RR1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    FileStorage --&gt; RR2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    FileStorage --&gt; RR3</span></span></code></pre></div><p><strong>Key Points:</strong></p><ul><li>All Roxie instances share the same ZRS file storage (no duplication)</li><li>Each environment (General/Restricted) updates independently</li><li>Each color (Green/Blue/Yellow) represents a separate availability zone</li><li>File Server Dali is a single point of failure, mitigated by dormant mirror</li></ul><p>Each of these environments is configured to pull the files from the FileServer, but share the target location so no files are actually copied when packages are deployed. ?Should queries avoid copying?</p><p>If there are any static roxie instances that are always available they will be defined in the environment in the classic way. Dynamic instances need a different treatment. The configuration will be included, but they will be defined to have 0 replicas in K8s, and no RoxieServer instances in the bare-metal configuration.</p><h2 id="spinning-up-new-instances" tabindex="-1">Spinning up new instances. <a class="header-anchor" href="#spinning-up-new-instances" aria-label="Permalink to &quot;Spinning up new instances.&quot;">​</a></h2><p>The current roxie configuration does not lend itself well to individually-identifiable dynamically scaled roxies. The configurations tend to be static. Kubernetes can scale by increasing the number of replicas, but that will increase the number of instances behind a load balancer, rather than creating uniquely identifiable instances. That may be the desired approach some of the time...</p><h3 id="k8s" tabindex="-1">K8s <a class="header-anchor" href="#k8s" aria-label="Permalink to &quot;K8s&quot;">​</a></h3><p>Add a new roxieinstance section to the helm chart. It should contain a name that is used to make the service-endpoints unique, and the name of the roxie configuration that is being used as the base.</p><p>A better solution would be to allow an independent child helm chart to be deployed to create a roxie instance. This should be discussed.</p><h3 id="bare-metal" tabindex="-1">Bare metal <a class="header-anchor" href="#bare-metal" aria-label="Permalink to &quot;Bare metal&quot;">​</a></h3><p>Take an existing environment.xml. Add RoxieServerProcess instances to match the configuration being scaled up. Deploy the environment.xml to the nodes that are being used and start the system.</p><h1 id="configuring-query-priorities-and-caches" tabindex="-1">Configuring query priorities and caches <a class="header-anchor" href="#configuring-query-priorities-and-caches" aria-label="Permalink to &quot;Configuring query priorities and caches&quot;">​</a></h1><p>More information to be included here later..</p>`,27)]))}const g=s(t,[["render",l]]);export{E as __pageData,g as default};
